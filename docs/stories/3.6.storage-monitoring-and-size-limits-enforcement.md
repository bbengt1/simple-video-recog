# Story 3.6: Storage Monitoring and Size Limits Enforcement

## Status
Approved

## Story
**As a** developer,
**I want** to monitor disk usage and enforce storage limits,
**so that** the system doesn't consume unlimited disk space (NFR10: <4GB for 30 days).

## Acceptance Criteria
1. Storage monitor module (core/storage_monitor.py) implements StorageMonitor class with check_usage() method
2. max_storage_gb configuration parameter specifies limit (default: 4GB)
3. check_usage() calculates total size of data/events directory (database + logs + images)
4. Size calculation uses os.path.getsize() recursively through all subdirectories
5. check_usage() returns StorageStats object: total_bytes, limit_bytes, percentage_used, is_over_limit
6. Storage check performed every 100 events (configurable via storage_check_interval)
7. If storage exceeds limit, log ERROR: "Storage limit exceeded: [X]GB / [Y]GB ([Z]%)"
8. Over-limit action (NFR28): Trigger graceful shutdown with exit code indicating storage full
9. Warning threshold: Log WARNING at 80% of limit ("Storage at 3.2GB / 4GB (80%), approaching limit")
10. Storage stats logged in runtime status display: "Storage: 1.2GB / 4GB (30%)"
11. Unit tests verify: size calculation, limit enforcement, warning thresholds
12. Integration test: Simulate storage growth to limit, verify warning and shutdown trigger

## Tasks / Subtasks
- [ ] Task 1: Create StorageMonitor class in core/storage_monitor.py (AC: 1)
  - [ ] Implement __init__ method with SystemConfig dependency injection
  - [ ] Add check_usage() method signature
  - [ ] Import required modules: os, pathlib, dataclasses
- [ ] Task 2: Implement StorageStats data structure (AC: 5)
  - [ ] Create StorageStats dataclass with total_bytes, limit_bytes, percentage_used, is_over_limit fields
  - [ ] Add proper type hints and field descriptions
  - [ ] Implement percentage calculation logic
- [ ] Task 3: Implement directory size calculation (AC: 3, 4)
  - [ ] Implement recursive directory size calculation using os.path.getsize()
  - [ ] Calculate total size of data/events directory including all subdirectories
  - [ ] Handle file system errors gracefully (permission denied, missing files)
  - [ ] Convert bytes to appropriate units for logging (GB, MB)
- [ ] Task 4: Implement storage limit configuration (AC: 2)
  - [ ] Read max_storage_gb from SystemConfig (default: 4.0 GB)
  - [ ] Convert GB to bytes for calculations
  - [ ] Validate configuration values (positive numbers)
- [ ] Task 5: Implement storage checking and thresholds (AC: 7, 8, 9)
  - [ ] Implement warning threshold logic (80% of limit)
  - [ ] Implement critical threshold logic (100% of limit)
  - [ ] Log appropriate WARNING/ERROR messages with formatted sizes
  - [ ] Return boolean indicating if shutdown should be triggered
- [ ] Task 6: Implement periodic checking mechanism (AC: 6)
  - [ ] Add event counter for periodic checks
  - [ ] Implement storage_check_interval configuration (default: every 100 events)
  - [ ] Return early if check interval not reached
  - [ ] Reset counter after successful check
- [ ] Task 7: Integrate with runtime status display (AC: 10)
  - [ ] Format storage stats for status display ("Storage: 1.2GB / 4GB (30%)")
  - [ ] Provide method to get formatted status string
  - [ ] Ensure thread-safe access to storage statistics
- [ ] Task 8: Create comprehensive unit tests (AC: 11)
  - [ ] Test size calculation for various directory structures
  - [ ] Test threshold detection (warning at 80%, critical at 100%)
  - [ ] Test configuration validation
  - [ ] Test error handling (permission denied, missing directories)
  - [ ] Mock file system operations for predictable testing
- [ ] Task 9: Create integration test (AC: 12)
  - [ ] Simulate storage growth by creating test files
  - [ ] Verify warning triggers at 80% threshold
  - [ ] Verify shutdown trigger at 100% threshold
  - [ ] Test periodic checking behavior
  - [ ] Clean up test files after completion

## Dev Notes

### Previous Story Insights
From Stories 3.4 and 3.5: File system operations established patterns for directory creation and error handling. Configuration management patterns from SystemConfig. Logging patterns for different severity levels (WARNING, ERROR).

### Data Models
- **StorageStats**: Dataclass containing total_bytes, limit_bytes, percentage_used, is_over_limit [Source: architecture/storage-monitor.md]
- **SystemConfig**: Contains max_storage_gb and storage_check_interval parameters [Source: architecture/systemconfig.md]

### File Locations
- **Module Location**: core/storage_monitor.py [Source: architecture/storage-monitor.md]
- **Class Name**: StorageMonitor [Source: architecture/storage-monitor.md]
- **Directory Monitored**: data/events/ (includes database, logs, images) [Source: architecture/storage-monitor.md]
- **Dependencies**: SystemConfig for configuration access [Source: architecture/storage-monitor.md]

### Technical Constraints
- **Storage Limit**: 4GB default (configurable via max_storage_gb) [Source: epic-3-event-persistence-data-management.md AC: 2]
- **Warning Threshold**: 80% of limit triggers WARNING log [Source: epic-3-event-persistence-data-management.md AC: 9]
- **Critical Threshold**: 100% of limit triggers ERROR log and graceful shutdown [Source: epic-3-event-persistence-data-management.md AC: 7, 8]
- **Check Frequency**: Every 100 events (configurable via storage_check_interval) [Source: epic-3-event-persistence-data-management.md AC: 6]
- **Size Calculation**: Recursive calculation of data/events directory [Source: epic-3-event-persistence-data-management.md AC: 3, 4]

### Testing Requirements
- **Test Location**: tests/unit/test_storage_monitor.py [Source: architecture/test-organization.md]
- **Test Framework**: pytest with standard assertions [Source: architecture/test-organization.md]
- **Coverage Target**: ≥70% including error scenarios [Source: architecture/test-organization.md]
- **Mock Strategy**: Mock file system operations and directory structures [Source: architecture/test-organization.md]
- **Integration Test**: tests/integration/test_storage_monitor_integration.py [Source: architecture/test-organization.md]

### Project Structure Notes
- Follows core/ module organization for platform-independent components [Source: architecture/repository-structure.md]
- Storage monitor is a system monitoring component alongside metrics collector [Source: architecture/repository-structure.md]
- No structural conflicts identified between epic requirements and architecture patterns

## Testing

### Testing Standards
- **Test File Location**: tests/unit/test_storage_monitor.py for unit tests, tests/integration/test_storage_monitor_integration.py for integration tests [Source: architecture/test-organization.md]
- **Test Framework**: pytest 7.4+ with pytest-cov for coverage reporting [Source: architecture/test-organization.md]
- **Coverage Requirements**: Target ≥70% coverage across core/storage_monitor.py [Source: architecture/test-organization.md]
- **Mocking Strategy**: Use pytest-mock for file system operations, create mock directory structures for testing [Source: architecture/test-organization.md]
- **Test Patterns**: Arrange-Act-Assert pattern, test both success and error scenarios [Source: architecture/unit-test-best-practices.md]
- **Performance Testing**: Include timing assertions for size calculation operations [Source: architecture/performance-test-examples.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story draft created from Epic 3 requirements | SM Agent (Bob) |
| 2025-11-10 | 1.1 | Status changed from Draft to Approved after checklist validation | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*
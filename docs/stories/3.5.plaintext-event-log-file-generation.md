# Story 3.5: Plaintext Event Log File Generation

## Status
Approved

## Story
**As a** developer,
**I want** to write human-readable plaintext event logs,
**so that** I can quickly review events manually without parsing JSON or querying the database.

## Acceptance Criteria
1. Plaintext logger module (core/plaintext_logger.py) implements PlaintextEventLogger class
2. Plaintext files organized by date: data/events/YYYY-MM-DD/events.log (one file per day)
3. Log format matches Technical Assumptions specification:
   ```
   [2025-11-08 14:32:15] EVENT: Person detected at front door (confidence: 92%)
     - Objects: person (92%), package (87%)
     - Description: Person in blue shirt carrying brown package approaching front door
     - Image: data/events/2025-11-08/evt_12345.jpg
   ```
4. Timestamp in local timezone with format: YYYY-MM-DD HH:MM:SS
5. Event separator: Blank line between events for readability
6. Detected objects listed with confidence percentages
7. LLM description included on "Description:" line
8. Image path as relative path from project root
9. Metadata line (optional, at DEBUG level): Frame number, inference times
10. File rotation synchronized with JSON logger (same midnight boundary)
11. Performance: Write completes in <5ms
12. Unit tests verify: log format, multi-object display, timestamp formatting
13. Integration test: Generate logs for 50 events, manually inspect for readability and correctness

## Tasks / Subtasks
- [ ] Task 1: Create PlaintextEventLogger class in core/plaintext_logger.py (AC: 1)
  - [ ] Implement __init__ method with SystemConfig dependency injection
  - [ ] Add log_event(event: Event) method signature
  - [ ] Import required modules: pathlib, datetime, logging
- [ ] Task 2: Implement date-based file organization (AC: 2, 10)
  - [ ] Extract date from event timestamp (YYYY-MM-DD format)
  - [ ] Construct file path: data/events/YYYY-MM-DD/events.log
  - [ ] Create date directories automatically using pathlib
  - [ ] Synchronize file rotation with JSON logger (same midnight boundary)
- [ ] Task 3: Implement plaintext log formatting (AC: 3, 4, 5, 6, 7, 8, 9)
  - [ ] Format timestamp in local timezone (YYYY-MM-DD HH:MM:SS)
  - [ ] Create event header line with motion confidence
  - [ ] Format detected objects list with confidence percentages
  - [ ] Add LLM description line
  - [ ] Include image path as relative path
  - [ ] Add optional metadata line for DEBUG level (frame number, inference times)
  - [ ] Add blank line separator between events
- [ ] Task 4: Implement atomic write operations (AC: 11)
  - [ ] Write to temporary file first using tempfile module
  - [ ] Use os.rename() for atomic file replacement
  - [ ] Set file permissions to 0644 (0o644)
  - [ ] Implement append-only mode for concurrent safety
- [ ] Task 5: Add performance monitoring and error handling (AC: 11)
  - [ ] Measure and log write operation timing (<5ms target)
  - [ ] Add proper exception handling for file operations
  - [ ] Log errors at appropriate levels without crashing pipeline
  - [ ] Return success/failure status for pipeline integration
- [ ] Task 6: Create comprehensive unit tests (AC: 12)
  - [ ] Test log format and timestamp formatting
  - [ ] Test multi-object display with confidence percentages
  - [ ] Test event separator (blank lines)
  - [ ] Test optional metadata line at DEBUG level
  - [ ] Test error scenarios (permission denied, disk full)
  - [ ] Mock Event objects for testing
- [ ] Task 7: Create integration test (AC: 13)
  - [ ] Generate logs for 50 events across multiple days
  - [ ] Verify correct file structure and naming
  - [ ] Manually inspect log readability and format correctness
  - [ ] Test file rotation behavior

## Dev Notes

### Previous Story Insights
From Story 3.4 JSON Event Log File Generation: File system operations use atomic write patterns (temp file + os.rename()). Date-based file organization and directory creation patterns established. Performance targets and error handling patterns should be consistent.

### Data Models
- **Event Model**: Uses Pydantic BaseModel with specific fields for formatting [Source: architecture/event.md]
- **Event Structure**: Contains event_id, timestamp, camera_id, motion_confidence, detected_objects, llm_description, image_path [Source: architecture/event.md]
- **detected_objects**: List of DetectedObject instances with label and confidence for formatting [Source: architecture/models.py via event.md]

### File Locations
- **Module Location**: core/plaintext_logger.py [Source: architecture/plaintext-event-logger.md]
- **Class Name**: PlaintextEventLogger [Source: architecture/plaintext-event-logger.md]
- **File Organization**: data/events/YYYY-MM-DD/events.log [Source: architecture/plaintext-event-logger.md]
- **Dependencies**: SystemConfig for configuration access [Source: architecture/plaintext-event-logger.md]

### Technical Constraints
- **Performance Target**: <5ms per log write operation [Source: epic-3-event-persistence-data-management.md AC: 11]
- **Log Format**: Specific format with timestamp, objects list, description, image path [Source: epic-3-event-persistence-data-management.md AC: 3]
- **Timestamp Format**: Local timezone YYYY-MM-DD HH:MM:SS [Source: epic-3-event-persistence-data-management.md AC: 4]
- **File Rotation**: Synchronized with JSON logger at midnight [Source: epic-3-event-persistence-data-management.md AC: 10]
- **Event Separator**: Blank line between events [Source: epic-3-event-persistence-data-management.md AC: 5]

### Testing Requirements
- **Test Location**: tests/unit/test_plaintext_logger.py [Source: architecture/test-organization.md]
- **Test Framework**: pytest with standard assertions [Source: architecture/test-organization.md]
- **Coverage Target**: ≥70% including error scenarios [Source: architecture/test-organization.md]
- **Mock Strategy**: Mock Event objects and file system operations [Source: architecture/test-organization.md]
- **Integration Test**: tests/integration/test_plaintext_logger_integration.py [Source: architecture/test-organization.md]

### Project Structure Notes
- Follows core/ module organization for platform-independent components [Source: architecture/repository-structure.md]
- Plaintext logger is a persistence layer component alongside JSON logger and database [Source: architecture/repository-structure.md]
- No structural conflicts identified between epic requirements and architecture patterns

## Testing

### Testing Standards
- **Test File Location**: tests/unit/test_plaintext_logger.py for unit tests, tests/integration/test_plaintext_logger_integration.py for integration tests [Source: architecture/test-organization.md]
- **Test Framework**: pytest 7.4+ with pytest-cov for coverage reporting [Source: architecture/test-organization.md]
- **Coverage Requirements**: Target ≥70% coverage across core/plaintext_logger.py [Source: architecture/test-organization.md]
- **Mocking Strategy**: Use pytest-mock for file system operations, create mock Event objects for testing [Source: architecture/test-organization.md]
- **Test Patterns**: Arrange-Act-Assert pattern, test both success and error scenarios [Source: architecture/unit-test-best-practices.md]
- **Performance Testing**: Include timing assertions to validate <5ms requirement [Source: architecture/performance-test-examples.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story draft created from Epic 3 requirements | SM Agent (Bob) |
| 2025-11-10 | 1.1 | Status changed from Draft to Approved after checklist validation | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*
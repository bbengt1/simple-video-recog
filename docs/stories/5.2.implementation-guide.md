# Story 5.2: Event API Endpoints - Implementation Guide

**Quick Reference for Developers**

---

## ðŸŽ¯ Story Overview

**Goal:** Create REST API endpoints for querying events with filtering and pagination.

**Effort:** 8-10 hours (1.5 days)

**Priority:** HIGH (Blocks Stories 5.4-5.8)

**Depends On:** Story 5.1 (FastAPI Server Setup)

---

## ðŸ“‹ Pre-Implementation Checklist

Before you start, verify:

- [ ] Story 5.1 is complete and merged
- [ ] FastAPI server starts successfully (`python web_server.py`)
- [ ] Health check endpoint works (`curl http://localhost:8000/api/health`)
- [ ] Database contains events for testing
  ```bash
  sqlite3 data/events.db "SELECT COUNT(*) FROM events"
  # Should return > 0
  ```
- [ ] Migration 003 indexes exist
  ```bash
  sqlite3 data/events.db "SELECT name FROM sqlite_master WHERE type='index'"
  # Should show idx_events_timestamp, idx_events_camera, etc.
  ```

---

## ðŸš€ Quick Start (TDD Approach)

### 1. Create Test Files (10 min)

```bash
# Create test directories
mkdir -p tests/api tests/performance

# Create test files
touch tests/api/test_events.py
touch tests/api/test_metrics.py
touch tests/performance/test_api_load.py
```

### 2. Write Failing Tests (45 min)

Copy test code from `docs/stories/5.2.story.md` section "Testing Requirements"

Run tests (should fail):
```bash
pytest tests/api/test_events.py -v
pytest tests/api/test_metrics.py -v
```

### 3. Implement Core Components (5-6 hours)

**Order of Implementation:**

1. **Pydantic Models** (`api/models.py`) - 45 min
   - Create all request/response models
   - Add validation rules
   - Add JSON schema examples
   - Test: Model validation works

2. **Event Routes** (`api/routes/events.py`) - 90 min
   - Implement `list_events()` with pagination
   - Implement `get_event()` with error handling
   - Implement `get_event_image()` with caching
   - Test: `pytest tests/api/test_events.py::test_list_events_success`

3. **Metrics Routes** (`api/routes/metrics.py`) - 30 min
   - Implement `get_metrics()`
   - Implement `get_config()`
   - Test: `pytest tests/api/test_metrics.py`

4. **MetricsCollector Singleton** (`core/metrics.py`) - 15 min
   - Add `get_metrics_collector()` function
   - Test: Can access singleton from API

5. **Integrate Routes** (`api/app.py`) - 15 min
   - Update `create_app()` to include new routers
   - Test: OpenAPI docs show new endpoints

### 4. Manual Testing (30 min)

```bash
# Terminal 1: Start web server
python web_server.py

# Terminal 2: Test endpoints
# List events
curl "http://localhost:8000/api/events?limit=10" | jq

# List events with time range
curl "http://localhost:8000/api/events?start=2025-11-01T00:00:00Z&end=2025-11-10T23:59:59Z" | jq

# Get single event (replace with real event_id)
curl "http://localhost:8000/api/events/evt_123456_abc" | jq

# Get event image
curl "http://localhost:8000/api/events/evt_123456_abc/image" --output test.jpg

# Get metrics
curl "http://localhost:8000/api/metrics" | jq

# Get config
curl "http://localhost:8000/api/config" | jq

# Browser: Open http://localhost:8000/docs
```

### 5. Performance Testing (30 min)

```bash
# Run load tests
pytest tests/performance/test_api_load.py -v

# Manual load test with ApacheBench (if available)
ab -n 1000 -c 50 http://localhost:8000/api/events?limit=100
```

### 6. Documentation (30 min)

- Update README with API examples
- Verify OpenAPI docs are complete
- Add troubleshooting section

---

## ðŸ”§ Implementation Details

### Critical: Database Query Optimization

**Use Indexes from Migration 003:**

```python
# BAD: No index usage
cursor.execute("SELECT * FROM events ORDER BY created_at DESC")

# GOOD: Uses idx_events_timestamp index
cursor.execute("SELECT * FROM events ORDER BY timestamp DESC")

# GOOD: Uses idx_events_timestamp_camera composite index
cursor.execute("""
    SELECT * FROM events
    WHERE timestamp >= ? AND camera_id = ?
    ORDER BY timestamp DESC
""", (start_time, camera_id))
```

**Why?** Indexes provide 10x speedup for queries. Without them, response time >5s for 10K events.

---

### Critical: Event Image Path Transformation

**Database stores absolute paths, API needs relative URLs:**

```python
# Database: data/events/2025-11-08/evt_123_abc.jpg
# API should return: /images/2025-11-08/evt_123_abc.jpg

# Implementation:
image_path = f"/images/{row['image_path'].split('/')[-2]}/{row['image_path'].split('/')[-1]}"
```

**Why?** Browser needs URL, not filesystem path.

---

### Critical: Detected Objects JSON Parsing

**Database stores JSON string, API needs Pydantic objects:**

```python
# Parse JSON string
detected_objects_json = json.loads(row['detected_objects']) if row['detected_objects'] else []

# Convert to Pydantic models
detected_objects = [
    DetectedObject(
        label=obj['label'],
        confidence=obj['confidence'],
        bbox=BoundingBox(**obj['bbox'])
    )
    for obj in detected_objects_json
]
```

**Why?** Pydantic provides type validation and auto-documentation.

---

### Critical: HTTP Caching Headers for Images

**Images should be cached for 7 days:**

```python
return FileResponse(
    image_path,
    media_type="image/jpeg",
    headers={
        "Cache-Control": "public, max-age=604800",  # 7 days in seconds
        "X-Request-ID": request_id
    }
)
```

**Why?** Reduces bandwidth and improves dashboard performance.

---

### Critical: Error Response Format

**Consistent error format across all endpoints:**

```python
raise HTTPException(
    status_code=404,
    detail={
        "code": "EVENT_NOT_FOUND",
        "message": f"Event with ID '{event_id}' not found",
        "timestamp": datetime.now().isoformat(),
        "request_id": request_id
    }
)
```

**Why?** Frontend can parse errors consistently.

---

## âœ… Acceptance Criteria Checklist

### AC 1: Event List Endpoint
- [ ] `GET /api/events` returns paginated list
- [ ] `limit` parameter works (default 100, max 1000)
- [ ] `offset` parameter works (default 0)
- [ ] `start` parameter filters by timestamp
- [ ] `end` parameter filters by timestamp
- [ ] `camera_id` parameter filters by camera
- [ ] Response includes: events, total, limit, offset
- [ ] Events ordered by timestamp DESC
- [ ] Response time <500ms for 100 events

### AC 2: Single Event Endpoint
- [ ] `GET /api/events/{event_id}` returns full event
- [ ] Returns 404 if not found
- [ ] Includes all fields (objects, description, paths)
- [ ] Response time <100ms

### AC 3: Event Image Endpoint
- [ ] `GET /api/events/{event_id}/image` serves JPEG
- [ ] Returns image with correct MIME type
- [ ] Returns 404 if image missing
- [ ] Cache-Control header present (7 days)
- [ ] Response time <200ms

### AC 4: System Metrics Endpoint
- [ ] `GET /api/metrics` returns current metrics
- [ ] Includes all metric fields
- [ ] Data from MetricsCollector singleton
- [ ] Response time <100ms

### AC 5: Configuration Endpoint
- [ ] `GET /api/config` returns sanitized config
- [ ] Excludes RTSP URL and passwords
- [ ] Includes camera_id, thresholds, etc.
- [ ] Response time <50ms

### AC 6: Pydantic Models
- [ ] All models defined in `api/models.py`
- [ ] JSON schema validation works
- [ ] OpenAPI docs include all models
- [ ] Examples provided for each model

### AC 7: Database Queries Optimized
- [ ] Uses idx_events_timestamp index
- [ ] Uses idx_events_camera index
- [ ] Query execution <100ms for 10K events

### AC 8: Error Handling
- [ ] 400 for invalid query parameters
- [ ] 404 for missing event/image
- [ ] 500 for database errors
- [ ] Consistent error format

### AC 9: Response Validation
- [ ] All responses validated against Pydantic
- [ ] Datetime serialization to ISO 8601
- [ ] Correct Content-Type headers
- [ ] Consistent error response format

### AC 10: API Documentation
- [ ] OpenAPI docs at /docs show all endpoints
- [ ] Descriptions and examples provided
- [ ] Request/response schemas visible
- [ ] Example responses for each endpoint

### AC 11: Performance Testing
- [ ] Load test with 1000 concurrent requests
- [ ] API responds within SLA (<500ms)
- [ ] No database connection exhaustion
- [ ] Memory stable (<200MB)

### AC 12: Integration with Story 5.1
- [ ] Uses FastAPI app from 5.1
- [ ] Uses read-only DB connection from 5.1
- [ ] Routes added via router inclusion
- [ ] No breaking changes to health check

---

## ðŸ§ª Testing Strategy

### Unit Tests (120 min, >80% coverage)

**Test Files:**
- `tests/api/test_events.py` - Event endpoint tests
- `tests/api/test_metrics.py` - Metrics endpoint tests

**Key Tests:**
```bash
# Run all API tests
pytest tests/api/ --cov=api/routes --cov-report=term-missing

# Run specific test
pytest tests/api/test_events.py::test_list_events_success -v

# Check coverage
pytest tests/api/ --cov=api --cov-report=html
open htmlcov/index.html
```

**Coverage Targets:**
- api/routes/events.py: >85%
- api/routes/metrics.py: >80%
- api/models.py: >90% (model validation)

---

### Performance Tests (30 min)

```bash
# Run performance tests
pytest tests/performance/test_api_load.py -v

# Manual load test with curl
for i in {1..100}; do
  curl -s "http://localhost:8000/api/events?limit=100" > /dev/null &
done
wait

# Monitor response times
time curl "http://localhost:8000/api/events?limit=100"
```

**Targets:**
- Event list (100 events): <500ms
- Single event: <100ms
- Image serving: <200ms
- Metrics: <100ms
- P95 under load: <500ms

---

### Manual Testing (30 min)

**Checklist:**
- [ ] Start server: `python web_server.py`
- [ ] Test event list: `curl http://localhost:8000/api/events?limit=10`
- [ ] Test pagination: offset=10, offset=20
- [ ] Test time range: `?start=2025-11-01T00:00:00Z&end=2025-11-10T23:59:59Z`
- [ ] Test camera filter: `?camera_id=front_door`
- [ ] Test invalid limit: `?limit=2000` (should return 422)
- [ ] Test single event: `curl http://localhost:8000/api/events/evt_123_abc`
- [ ] Test event not found: `curl http://localhost:8000/api/events/invalid`
- [ ] Test event image: `curl http://localhost:8000/api/events/evt_123_abc/image`
- [ ] Test metrics: `curl http://localhost:8000/api/metrics`
- [ ] Test config: `curl http://localhost:8000/api/config`
- [ ] Verify OpenAPI docs: http://localhost:8000/docs
- [ ] Test all endpoints in Swagger UI

---

## ðŸš¨ Common Issues & Solutions

### Issue 1: "Query too slow (>1s)"

**Symptom:**
```
Event list query takes 2-3 seconds for 10K events
```

**Diagnosis:**
```bash
# Check if indexes exist
sqlite3 data/events.db "SELECT name FROM sqlite_master WHERE type='index' AND tbl_name='events'"
```

**Solution:**
```bash
# Apply migration 003 if missing
sqlite3 data/events.db < migrations/003_add_api_indexes.sql

# Verify indexes used
sqlite3 data/events.db "EXPLAIN QUERY PLAN SELECT * FROM events ORDER BY timestamp DESC LIMIT 100"
# Should show "USING INDEX idx_events_timestamp"
```

---

### Issue 2: "Image path 404 errors"

**Symptom:**
```json
{
  "error": {
    "code": "IMAGE_NOT_FOUND",
    "message": "Image for event 'evt_123_abc' not found"
  }
}
```

**Diagnosis:**
```bash
# Check image path in database
sqlite3 data/events.db "SELECT event_id, image_path FROM events LIMIT 1"
```

**Common Causes:**
- Database stores absolute path, but file doesn't exist
- File permissions prevent reading
- Path transformation error in API code

**Solution:**
```python
# Verify image exists before returning
image_path = FilePath(row['image_path'])
if not image_path.exists():
    raise HTTPException(404, detail="Image not found")
```

---

### Issue 3: "Detected objects JSON parse error"

**Symptom:**
```
json.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)
```

**Cause:** Database field is NULL or empty string

**Solution:**
```python
# Safe parsing with fallback
detected_objects = json.loads(row['detected_objects']) if row['detected_objects'] else []
```

---

### Issue 4: "Datetime serialization error"

**Symptom:**
```
TypeError: Object of type datetime is not JSON serializable
```

**Cause:** Manual JSON serialization instead of Pydantic

**Solution:**
```python
# BAD: Manual JSON
return {"timestamp": datetime.now()}

# GOOD: Pydantic model
return EventResponse(timestamp=datetime.now())  # Auto-serializes to ISO 8601
```

---

### Issue 5: "CORS error from browser"

**Error in browser console:**
```
Access to fetch at 'http://localhost:8000/api/events' has been blocked by CORS policy
```

**Solution:**
Verify CORS middleware in `api/app.py`:
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:8000", "http://127.0.0.1:8000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## ðŸ“Š Success Metrics

Track these metrics during implementation:

| Metric | Target | How to Measure |
|--------|--------|----------------|
| Event list (100) | <500ms | `time curl "http://localhost:8000/api/events?limit=100"` |
| Single event | <100ms | `time curl "http://localhost:8000/api/events/evt_123"` |
| Event image | <200ms | `time curl "http://localhost:8000/api/events/evt_123/image"` |
| Metrics | <100ms | `time curl "http://localhost:8000/api/metrics"` |
| P95 under load | <500ms | `pytest tests/performance/test_api_load.py` |
| Unit test coverage | >80% | `pytest --cov=api/routes` |

---

## ðŸŽ“ Learning Resources

**FastAPI:**
- Query parameters: https://fastapi.tiangolo.com/tutorial/query-params/
- Path parameters: https://fastapi.tiangolo.com/tutorial/path-params/
- Response models: https://fastapi.tiangolo.com/tutorial/response-model/
- Error handling: https://fastapi.tiangolo.com/tutorial/handling-errors/

**Pydantic:**
- Models: https://docs.pydantic.dev/latest/concepts/models/
- Validation: https://docs.pydantic.dev/latest/concepts/validators/
- JSON schema: https://docs.pydantic.dev/latest/concepts/json_schema/

**SQLite:**
- Query planning: https://www.sqlite.org/eqp.html
- Indexes: https://www.sqlite.org/queryplanner.html

**HTTP Caching:**
- Cache-Control: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control

---

## â­ï¸ Next Steps After Story 5.2

Once this story is complete:

1. **Story 5.3:** Real-Time Event Streaming (WebSocket)
   - Add WebSocket endpoint at `/ws/events`
   - Integrate with EventManager for real-time broadcasts
   - Implement reconnection logic

2. **Story 5.4:** Dashboard HTML/CSS Framework
   - Build responsive dashboard layout
   - Consume API endpoints from 5.2
   - Display event feed and metrics

3. **Story 5.5:** Event Feed Component
   - Connect to WebSocket for live updates
   - Use `/api/events` for historical data
   - Implement pagination UI

---

## ðŸ“ Definition of Done

Before marking this story complete, verify:

### Implementation
- [ ] All 12 acceptance criteria met
- [ ] All 5 API endpoints implemented
- [ ] Pydantic models defined with validation
- [ ] Error handling comprehensive
- [ ] Query optimization with indexes

### Testing
- [ ] Unit tests passing (>80% coverage)
- [ ] Performance tests passing (<500ms)
- [ ] Manual testing checklist complete
- [ ] Load test with 1000 requests successful
- [ ] No memory leaks under load

### Quality
- [ ] Code reviewed and approved
- [ ] No linting errors: `ruff check api/`
- [ ] Type hints added: `mypy api/`
- [ ] OpenAPI docs complete and accurate
- [ ] Error responses consistent

### Documentation
- [ ] README updated with API examples
- [ ] OpenAPI documentation verified
- [ ] Troubleshooting section added
- [ ] Code comments for complex queries

### Integration
- [ ] No breaking changes to Story 5.1
- [ ] Health check still works
- [ ] Static file serving still works
- [ ] All routes accessible via `/api` prefix

### Deployment
- [ ] Merged to main branch
- [ ] Git commit follows convention
- [ ] Dependencies updated (none for 5.2)
- [ ] Migration 003 documented as prerequisite

---

**Estimated Time Breakdown:**
- Pydantic models: 45 min
- Event routes: 90 min
- Metrics routes: 30 min
- MetricsCollector access: 15 min
- Integration: 15 min
- Unit tests: 120 min
- Performance tests: 30 min
- Manual testing: 30 min
- Documentation: 30 min
- Code review & fixes: 60 min
- **Total: 8-10 hours**

Good luck! ðŸš€

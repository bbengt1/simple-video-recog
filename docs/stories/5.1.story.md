# Story 5.1: FastAPI Server Setup

**Status:** Ready for Development

## Story

**As a** developer,
**I want** a FastAPI web server integrated with the main application,
**so that** I can serve the dashboard and provide API endpoints for event access.

## Business Value

This story establishes the foundational web server infrastructure for Epic 5, enabling:
- Web-based dashboard access without requiring database or log file expertise
- RESTful API for programmatic event access
- Foundation for real-time event streaming (Story 5.3)
- Separation of concerns (web serving vs video processing)

## Acceptance Criteria

### 1. FastAPI Application Setup
- FastAPI application created in `api/app.py` with application factory pattern
- Application runs on localhost:8000 (configurable via environment variable)
- CORS middleware configured for localhost origins
- Auto-generated OpenAPI documentation available at `/docs`
- Health check endpoint returns service status

### 2. Project Structure
- `api/` directory created with proper module structure:
  - `api/__init__.py`
  - `api/app.py` (FastAPI application factory)
  - `api/routes/__init__.py`
  - `api/routes/health.py` (health check endpoint)
  - `api/dependencies.py` (dependency injection)
  - `api/models.py` (Pydantic request/response models)
- `web_server.py` entry point created at project root
- Web server can be started independently of `main.py`

### 3. Configuration Management
- Web server reads from same `config/config.yaml` as main application
- Database path loaded from configuration
- Port number configurable via environment variable `WEB_PORT` (default: 8000)
- Host binding hardcoded to `127.0.0.1` (localhost-only for security)

### 4. Database Connection (Read-Only)
- Database connection established using read-only mode (`mode=ro`)
- Connection shared across requests (no connection pooling needed)
- Graceful error handling if database file doesn't exist
- Database dependency injection available for route handlers

### 5. Static File Serving
- Static files served from `web/` directory at root path `/`
- `index.html` served at `http://localhost:8000/`
- CSS files served from `/css/*`
- JavaScript files served from `/js/*`
- Event images served from `/images/*` (maps to `data/events/`)
- Proper MIME types for all file types

### 6. Health Check Endpoint
- `GET /api/health` returns JSON with service status
- Response includes:
  - `status`: "healthy" or "degraded"
  - `database`: "ok" or "error"
  - `uptime_seconds`: Server uptime
  - `version`: Application version from config
- Returns 200 OK when healthy, 503 Service Unavailable when degraded
- Response time <50ms

### 7. Startup Validation
- Database file existence checked on startup
- Database schema version verified (must be â‰¥3 for Epic 5)
- Warning logged if database schema outdated
- Server exits with clear error if database missing
- Startup logs include: port, host, database path, schema version

### 8. Graceful Shutdown
- SIGINT (Ctrl+C) triggers graceful shutdown
- SIGTERM triggers graceful shutdown
- Database connection closed on shutdown
- Shutdown logs "Web server stopped" message

### 9. Error Handling
- 404 responses for missing API endpoints
- 500 responses for server errors with error details in logs
- CORS errors return appropriate headers
- File not found errors for static files return 404

### 10. Logging Configuration
- Uses same logging configuration as main application
- Logs written to `logs/web_server.log`
- INFO level for normal operations
- ERROR level for failures
- Request logging for all API endpoints (method, path, status, duration)

### 11. Development Mode Support
- `--reload` flag for auto-reload during development
- Environment variable `DEV_MODE=1` enables hot reload
- Development mode logs debug information
- Production mode (default) disables debug output

### 12. Documentation
- README.md updated with web server startup instructions
- Architecture diagram added showing dual-process architecture
- API endpoint documentation in OpenAPI format
- Troubleshooting section for common startup issues

## Technical Specifications

### FastAPI Application Structure

```python
# api/app.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles
from pathlib import Path
import logging

from core.config import load_config
from api.routes import health

logger = logging.getLogger(__name__)

def create_app() -> FastAPI:
    """Create and configure FastAPI application."""

    # Load configuration
    config = load_config("config/config.yaml")

    # Create FastAPI app
    app = FastAPI(
        title="Local Video Recognition System API",
        version="1.0.0",
        description="REST API for event access and system monitoring",
        docs_url="/docs",
        redoc_url="/redoc"
    )

    # CORS middleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["http://localhost:8000", "http://127.0.0.1:8000"],
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

    # Include routers
    app.include_router(health.router, prefix="/api", tags=["health"])

    # Mount static files
    web_dir = Path(__file__).parent.parent / "web"
    if web_dir.exists():
        app.mount("/css", StaticFiles(directory=web_dir / "css"), name="css")
        app.mount("/js", StaticFiles(directory=web_dir / "js"), name="js")

        # Serve index.html at root
        from fastapi.responses import FileResponse

        @app.get("/")
        async def read_root():
            return FileResponse(web_dir / "index.html")

    # Mount event images
    events_dir = Path("data/events")
    if events_dir.exists():
        app.mount("/images", StaticFiles(directory=events_dir), name="images")

    logger.info("FastAPI application created")
    return app

app = create_app()
```

### Web Server Entry Point

```python
# web_server.py
import uvicorn
import os
import sys
import logging
from pathlib import Path

from core.logging_config import setup_logging
from core.config import load_config

def main():
    # Setup logging
    setup_logging()
    logger = logging.getLogger(__name__)

    logger.info("=" * 60)
    logger.info("Local Video Recognition System - Web Server")
    logger.info("=" * 60)

    # Load configuration
    try:
        config = load_config("config/config.yaml")
    except Exception as e:
        logger.error(f"Failed to load configuration: {e}")
        sys.exit(1)

    # Verify database exists
    db_path = Path(config.db_path)
    if not db_path.exists():
        logger.error(f"Database not found at {db_path}")
        logger.error("Please run the main application first to create the database")
        sys.exit(1)

    # Verify schema version
    import sqlite3
    try:
        conn = sqlite3.connect(str(db_path))
        cursor = conn.cursor()
        cursor.execute("SELECT version FROM schema_version")
        version = cursor.fetchone()[0]
        conn.close()

        if version < 3:
            logger.warning(f"Database schema version {version} detected")
            logger.warning("Epic 5 requires schema version 3+")
            logger.warning("Please run migrations/003_add_api_indexes.sql")
    except Exception as e:
        logger.warning(f"Could not verify schema version: {e}")

    # Get port from environment or default
    port = int(os.getenv("WEB_PORT", "8000"))
    host = "127.0.0.1"  # Localhost only for security

    # Check for development mode
    dev_mode = os.getenv("DEV_MODE") == "1"
    reload = dev_mode or "--reload" in sys.argv

    logger.info(f"Starting web server at http://{host}:{port}")
    logger.info(f"Database: {db_path}")
    logger.info(f"Development mode: {dev_mode}")
    logger.info(f"API documentation: http://{host}:{port}/docs")
    logger.info("Press Ctrl+C to stop")

    # Start server
    try:
        uvicorn.run(
            "api.app:app",
            host=host,
            port=port,
            reload=reload,
            log_config=None  # Use our logging config
        )
    except KeyboardInterrupt:
        logger.info("Web server stopped")
    except Exception as e:
        logger.error(f"Web server error: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
```

### Health Check Endpoint

```python
# api/routes/health.py
from fastapi import APIRouter, Depends, status
from pydantic import BaseModel
from datetime import datetime
import time

from api.dependencies import get_db_connection

router = APIRouter()

# Module-level startup time
startup_time = time.time()

class HealthResponse(BaseModel):
    status: str
    database: str
    uptime_seconds: int
    version: str
    timestamp: datetime

@router.get("/health", response_model=HealthResponse)
async def health_check(db_conn = Depends(get_db_connection)):
    """
    Health check endpoint.

    Returns service status including database connectivity and uptime.
    """
    # Check database
    db_status = "ok"
    try:
        cursor = db_conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM events")
        cursor.fetchone()
    except Exception as e:
        db_status = "error"

    # Calculate uptime
    uptime = int(time.time() - startup_time)

    # Determine overall status
    overall_status = "healthy" if db_status == "ok" else "degraded"

    status_code = status.HTTP_200_OK if overall_status == "healthy" else status.HTTP_503_SERVICE_UNAVAILABLE

    return HealthResponse(
        status=overall_status,
        database=db_status,
        uptime_seconds=uptime,
        version="1.0.0",
        timestamp=datetime.now()
    )
```

### Database Dependency

```python
# api/dependencies.py
import sqlite3
from pathlib import Path
from fastapi import Depends
import logging

from core.config import load_config

logger = logging.getLogger(__name__)

# Module-level configuration and connection
_config = None
_db_conn = None

def get_config():
    """Get or load system configuration."""
    global _config
    if _config is None:
        _config = load_config("config/config.yaml")
    return _config

def get_db_connection():
    """
    Get read-only database connection.

    Connection is created once and reused across requests.
    Read-only mode prevents write contention with main application.
    """
    global _db_conn

    if _db_conn is None:
        config = get_config()
        db_path = Path(config.db_path)

        # Open in read-only mode
        try:
            _db_conn = sqlite3.connect(
                f"file:{db_path}?mode=ro",
                uri=True,
                check_same_thread=False  # Allow sharing across threads
            )
            _db_conn.row_factory = sqlite3.Row  # Access columns by name
            logger.info(f"Database connection established (read-only): {db_path}")
        except Exception as e:
            logger.error(f"Failed to connect to database: {e}")
            raise

    return _db_conn

def close_db_connection():
    """Close database connection on shutdown."""
    global _db_conn
    if _db_conn is not None:
        _db_conn.close()
        _db_conn = None
        logger.info("Database connection closed")
```

## Dependencies

### Prerequisites
- Epic 4 complete (database schema v3 with API indexes)
- Migration 003 applied (`migrations/003_add_api_indexes.sql`)
- Python packages: `fastapi`, `uvicorn`, `python-multipart`

### Blocked By
- None (first story in Epic 5)

### Blocks
- Story 5.2: Event API Endpoints (requires FastAPI app)
- Story 5.3: Real-Time Event Streaming (requires web server)
- Story 5.4: Dashboard HTML/CSS Framework (requires static file serving)

## Implementation Guidance

### Step-by-Step Implementation

1. **Create directory structure** (15 minutes)
   ```bash
   mkdir -p api/routes
   touch api/__init__.py api/app.py api/routes/__init__.py api/routes/health.py api/dependencies.py api/models.py
   mkdir -p web/css web/js
   touch web_server.py
   ```

2. **Install dependencies** (5 minutes)
   ```bash
   pip install fastapi uvicorn[standard] python-multipart
   pip freeze > requirements.txt
   ```

3. **Implement database dependency** (20 minutes)
   - Create `api/dependencies.py` with read-only connection
   - Add configuration loading
   - Test connection with sample query

4. **Implement health check** (15 minutes)
   - Create `api/routes/health.py`
   - Define Pydantic response model
   - Implement database connectivity check

5. **Create FastAPI application** (30 minutes)
   - Implement `api/app.py` with application factory
   - Add CORS middleware
   - Include health router
   - Add startup/shutdown events

6. **Create web server entry point** (20 minutes)
   - Implement `web_server.py`
   - Add database validation
   - Add schema version check
   - Configure uvicorn

7. **Add static file serving** (15 minutes)
   - Mount web/ directory for HTML/CSS/JS
   - Mount data/events/ for images
   - Create placeholder index.html

8. **Add logging** (10 minutes)
   - Configure web server logging
   - Add request logging middleware
   - Test log output

9. **Test manually** (30 minutes)
   - Start web server
   - Access http://localhost:8000/docs
   - Test health check endpoint
   - Verify static file serving
   - Test graceful shutdown

10. **Write unit tests** (45 minutes)
    - Test health check endpoint
    - Test database dependency
    - Test static file serving
    - Test configuration loading

### Estimated Effort
- **Implementation:** 3-4 hours
- **Testing:** 1-2 hours
- **Documentation:** 1 hour
- **Total:** 5-7 hours (1 day)

## Testing Requirements

### Unit Tests

```python
# tests/api/test_health.py
import pytest
from fastapi.testclient import TestClient

from api.app import create_app

@pytest.fixture
def client():
    app = create_app()
    return TestClient(app)

def test_health_check_success(client):
    """Test health check returns 200 when database is accessible."""
    response = client.get("/api/health")

    assert response.status_code == 200
    data = response.json()
    assert data["status"] == "healthy"
    assert data["database"] == "ok"
    assert data["uptime_seconds"] >= 0
    assert "version" in data

def test_health_check_response_time(client):
    """Test health check responds in <50ms."""
    import time
    start = time.time()
    response = client.get("/api/health")
    duration = (time.time() - start) * 1000  # ms

    assert response.status_code == 200
    assert duration < 50, f"Health check took {duration}ms (target: <50ms)"

def test_cors_headers(client):
    """Test CORS headers are present."""
    response = client.options("/api/health")
    assert "access-control-allow-origin" in response.headers

def test_openapi_docs_available(client):
    """Test OpenAPI documentation is accessible."""
    response = client.get("/docs")
    assert response.status_code == 200
```

```python
# tests/api/test_dependencies.py
import pytest
from api.dependencies import get_db_connection, get_config

def test_db_connection_read_only():
    """Test database connection is read-only."""
    conn = get_db_connection()

    # Should succeed (read operation)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM events")
    count = cursor.fetchone()[0]
    assert count >= 0

    # Should fail (write operation)
    with pytest.raises(Exception):
        cursor.execute("INSERT INTO events (event_id) VALUES ('test')")

def test_config_loading():
    """Test configuration loads successfully."""
    config = get_config()
    assert config.db_path is not None
    assert config.camera_id is not None
```

### Integration Tests

```python
# tests/integration/test_web_server.py
import subprocess
import time
import requests
import pytest

@pytest.fixture(scope="module")
def web_server():
    """Start web server for integration tests."""
    proc = subprocess.Popen(
        ["python", "web_server.py"],
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE
    )
    time.sleep(2)  # Wait for server to start
    yield proc
    proc.terminate()
    proc.wait()

def test_web_server_starts(web_server):
    """Test web server starts successfully."""
    response = requests.get("http://localhost:8000/api/health")
    assert response.status_code == 200

def test_static_files_served(web_server):
    """Test static files are served."""
    response = requests.get("http://localhost:8000/")
    assert response.status_code in [200, 404]  # 404 ok if index.html not created yet

def test_api_docs_accessible(web_server):
    """Test OpenAPI docs are accessible."""
    response = requests.get("http://localhost:8000/docs")
    assert response.status_code == 200
    assert "swagger" in response.text.lower()
```

### Manual Testing Checklist

- [ ] Web server starts without errors
- [ ] Health check endpoint returns 200 OK
- [ ] OpenAPI docs accessible at /docs
- [ ] Static files served from /css, /js
- [ ] Event images served from /images
- [ ] Ctrl+C triggers graceful shutdown
- [ ] Database connection is read-only (cannot write)
- [ ] Server logs to logs/web_server.log
- [ ] Port configurable via WEB_PORT environment variable
- [ ] Development mode works with --reload flag

## Definition of Done

- [ ] All 12 acceptance criteria met
- [ ] FastAPI application created with health check endpoint
- [ ] Web server entry point created and tested
- [ ] Static file serving configured
- [ ] Database connection established (read-only)
- [ ] Unit tests written and passing (>80% coverage)
- [ ] Integration tests passing
- [ ] Manual testing checklist complete
- [ ] README.md updated with startup instructions
- [ ] Code reviewed and approved
- [ ] Merged to main branch

## Success Metrics

- Health check response time: <50ms (target met if <50ms)
- Server startup time: <5 seconds
- Unit test coverage: >80% for api/ directory
- Zero database write operations (verified via read-only connection)

## Notes

### Security Considerations
- Server binds to 127.0.0.1 only (no external access)
- Database connection is read-only (cannot modify data)
- No authentication required (localhost-only access)

### Future Enhancements (Out of Scope for 5.1)
- Authentication for remote access (Epic 6+)
- HTTPS support (Epic 6+)
- Rate limiting (Epic 6+)
- WebSocket support (Story 5.3)
- Event API endpoints (Story 5.2)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story creation | Winston (Architect) |


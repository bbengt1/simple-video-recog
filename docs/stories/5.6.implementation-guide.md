# Story 5.6: System Health Display - Implementation Guide

**Story:** 5.6 - System Health Display
**Estimated Effort:** 8-10 hours (1 day)
**Prerequisites:** Stories 5.1, 5.2, 5.4, 5.5 completed

---

## Overview

This guide provides step-by-step instructions for implementing the **System Health Display**, which fetches and displays system metrics and event statistics in the metrics panel.

**Key Components:**
1. **MetricsPanel** - Main component that polls `/api/metrics` every 5 seconds
2. **Health Indicators** - Visual indicators (green/yellow/red) for system health
3. **Formatters** - Utilities for formatting bytes, percentages, uptime
4. **Page Visibility** - Pause polling when tab is hidden

**Architecture Pattern:**
- **Polling-based** updates (every 5 seconds)
- **Page Visibility API** to pause when tab hidden
- **Visual health indicators** for quick status assessment

---

## Pre-Implementation Checklist

Before starting implementation, verify:

- [ ] **Story 5.2 Complete:** `/api/metrics` endpoint returns system and event statistics
- [ ] **Story 5.4 Complete:** Dashboard has `.metrics-panel` container
- [ ] **Story 5.5 Complete:** `app.js` bootstrap pattern established
- [ ] **Web server running:** `python web_server.py` on `http://localhost:8000`
- [ ] **Test endpoint:** `curl http://localhost:8000/api/metrics` returns JSON

---

## Implementation Steps

### Step 1: Verify /api/metrics Endpoint (10 minutes)

**Purpose:** Ensure backend provides metrics data

**Verification:**
```bash
# Test metrics endpoint
curl http://localhost:8000/api/metrics

# Expected response:
{
  "system": {
    "cpu_usage_percent": 45.2,
    "memory_used": 1288490188,
    "memory_total": 8589934592,
    "disk_used": 48318382080,
    "disk_total": 274877906944,
    "disk_usage_percent": 17.6,
    "system_uptime_seconds": 432000,
    "app_uptime_seconds": 18000
  },
  "events": {
    "total_events": 1250,
    "events_today": 150,
    "events_this_hour": 12,
    "events_per_hour_avg": 15.5,
    "events_per_hour_previous": 14.2
  },
  "cameras": [
    {
      "camera_id": "Camera 1",
      "event_count": 750,
      "last_event_time": "2025-11-10T14:30:45Z"
    },
    {
      "camera_id": "Camera 2",
      "event_count": 500,
      "last_event_time": "2025-11-10T14:25:12Z"
    }
  ]
}
```

**If endpoint fails:**
- Verify Story 5.2 implementation
- Check web server logs: `python web_server.py` (look for errors)
- Verify database exists: `ls -lh surveillance.db`

---

### Step 2: Create Health Indicators Utility (15 minutes)

**File:** `web/js/utils/healthIndicators.js`

**Purpose:** Determine health status (healthy/warning/critical) based on metric values

**Implementation:**

```javascript
// web/js/utils/healthIndicators.js

export function getHealthStatus(metric, value) {
  const thresholds = {
    cpu: { warning: 70, critical: 90 },
    memory: { warning: 80, critical: 90 },
    disk: { warning: 80, critical: 90 }
  };

  const threshold = thresholds[metric];
  if (!threshold) {
    console.warn(`[healthIndicators] Unknown metric: ${metric}`);
    return 'healthy';
  }

  if (value >= threshold.critical) return 'critical';
  if (value >= threshold.warning) return 'warning';
  return 'healthy';
}

export function getStatusColor(status) {
  const colors = {
    healthy: '#4caf50',   // Green
    warning: '#ff9800',   // Orange
    critical: '#f44336'   // Red
  };

  return colors[status] || colors.healthy;
}

export function getStatusLabel(status) {
  const labels = {
    healthy: 'Healthy',
    warning: 'Warning',
    critical: 'Critical'
  };

  return labels[status] || 'Unknown';
}
```

**Verification:**
```javascript
// Browser console
import { getHealthStatus, getStatusColor } from './utils/healthIndicators.js';

getHealthStatus('cpu', 45);   // "healthy"
getHealthStatus('cpu', 75);   // "warning"
getHealthStatus('cpu', 95);   // "critical"

getStatusColor('healthy');    // "#4caf50"
getStatusColor('critical');   // "#f44336"
```

---

### Step 3: Update Formatters Utility (20 minutes)

**File:** `web/js/utils/formatters.js`

**Purpose:** Add formatters for bytes, percentages, uptime

**Implementation:**

```javascript
// web/js/utils/formatters.js (additions to existing file)

// Existing formatters from Story 5.5
export function formatTimestamp(timestamp) { /* ... */ }
export function formatRelativeTime(timestamp) { /* ... */ }
export function formatConfidence(confidence) { /* ... */ }

// NEW: Format bytes (1288490188 → "1.2 GB")
export function formatBytes(bytes) {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
}

// NEW: Format percentage (45.234 → "45%")
export function formatPercentage(value) {
  return `${Math.round(value)}%`;
}

// NEW: Format uptime (432000 → "5d 0h 0m")
export function formatUptime(seconds) {
  if (seconds < 60) return '<1m';

  const days = Math.floor(seconds / (24 * 3600));
  const hours = Math.floor((seconds % (24 * 3600)) / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);

  const parts = [];
  if (days > 0) parts.push(`${days}d`);
  if (hours > 0) parts.push(`${hours}h`);
  if (minutes > 0) parts.push(`${minutes}m`);

  return parts.length > 0 ? parts.join(' ') : '<1m';
}

// NEW: Format number with commas (1250 → "1,250")
export function formatNumber(num) {
  return num.toLocaleString();
}
```

**Verification:**
```javascript
// Browser console
import { formatBytes, formatPercentage, formatUptime, formatNumber } from './utils/formatters.js';

formatBytes(1288490188);        // "1.2 GB"
formatPercentage(45.234);       // "45%"
formatUptime(432000);           // "5d 0h 0m"
formatNumber(1250);             // "1,250"
```

---

### Step 4: Implement MetricsPanel Component (90 minutes)

**File:** `web/js/components/MetricsPanel.js`

**Purpose:** Main component that fetches and renders metrics

**Critical Implementation Details:**
1. **Poll every 5 seconds** for updated metrics
2. **Pause polling** when tab is hidden (Page Visibility API)
3. **Handle errors** gracefully (show error state, keep stale data)
4. **Render three sections:** System Health, Event Statistics, Camera Activity

**Implementation:**

```javascript
// web/js/components/MetricsPanel.js

import ApiClient from '../services/ApiClient.js';
import { formatBytes, formatPercentage, formatUptime, formatNumber } from '../utils/formatters.js';
import { getHealthStatus } from '../utils/healthIndicators.js';

class MetricsPanel {
  constructor(containerSelector) {
    this.container = document.querySelector(containerSelector);
    if (!this.container) {
      throw new Error(`Container not found: ${containerSelector}`);
    }

    this.apiClient = new ApiClient();
    this.pollInterval = null;
    this.pollFrequency = 5000; // 5 seconds
    this.isVisible = true;
    this.lastMetrics = null; // Store last successful metrics (for stale data)

    // Setup Page Visibility API
    this.setupVisibilityListener();

    console.log('[MetricsPanel] Initialized');
  }

  async init() {
    console.log('[MetricsPanel] Fetching initial metrics...');

    // Initial load
    await this.fetchAndRenderMetrics();

    // Start polling
    this.startPolling();
  }

  async fetchAndRenderMetrics() {
    try {
      const metrics = await this.apiClient.getMetrics();
      this.lastMetrics = metrics; // Store for stale data fallback
      this.render(metrics);
      this.updateLastUpdated();
    } catch (error) {
      console.error('[MetricsPanel] Failed to fetch metrics:', error);

      if (this.lastMetrics) {
        // Show stale data with warning
        this.renderStaleDataWarning();
      } else {
        // No previous data, show error
        this.showError();
      }
    }
  }

  startPolling() {
    console.log('[MetricsPanel] Starting polling (every 5s)');

    this.pollInterval = setInterval(() => {
      if (this.isVisible) {
        this.fetchAndRenderMetrics();
      } else {
        console.log('[MetricsPanel] Tab hidden, skipping poll');
      }
    }, this.pollFrequency);
  }

  stopPolling() {
    console.log('[MetricsPanel] Stopping polling');
    if (this.pollInterval) {
      clearInterval(this.pollInterval);
      this.pollInterval = null;
    }
  }

  setupVisibilityListener() {
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('[MetricsPanel] Tab hidden, pausing polling');
        this.isVisible = false;
      } else {
        console.log('[MetricsPanel] Tab visible, resuming polling');
        this.isVisible = true;
        // Fetch immediately when tab becomes visible
        this.fetchAndRenderMetrics();
      }
    });
  }

  render(metrics) {
    // Clear container
    this.container.innerHTML = '';

    // Disk Space Warning (if critical)
    if (metrics.system.disk_usage_percent > 90) {
      const warning = this.createDiskWarning(metrics.system.disk_usage_percent);
      this.container.appendChild(warning);
    }

    // System Health Section
    const systemSection = this.createSystemHealthSection(metrics.system);
    this.container.appendChild(systemSection);

    // Event Statistics Section
    const eventsSection = this.createEventStatisticsSection(metrics.events);
    this.container.appendChild(eventsSection);

    // Camera Activity Section
    if (metrics.cameras && metrics.cameras.length > 0) {
      const camerasSection = this.createCameraActivitySection(metrics.cameras);
      this.container.appendChild(camerasSection);
    }
  }

  createSystemHealthSection(system) {
    const section = document.createElement('section');
    section.className = 'metrics-section';
    section.setAttribute('aria-label', 'System Health');

    const header = document.createElement('h3');
    header.textContent = 'System Health';
    section.appendChild(header);

    // CPU Usage
    const cpuMetric = this.createMetric(
      'CPU Usage',
      formatPercentage(system.cpu_usage_percent),
      system.cpu_usage_percent,
      getHealthStatus('cpu', system.cpu_usage_percent)
    );
    section.appendChild(cpuMetric);

    // Memory Usage
    const memoryPercent = (system.memory_used / system.memory_total) * 100;
    const memoryMetric = this.createMetric(
      'Memory Usage',
      `${formatBytes(system.memory_used)} / ${formatBytes(system.memory_total)}`,
      memoryPercent,
      getHealthStatus('memory', memoryPercent)
    );
    section.appendChild(memoryMetric);

    // Disk Usage
    const diskMetric = this.createMetric(
      'Disk Usage',
      `${formatBytes(system.disk_used)} / ${formatBytes(system.disk_total)}`,
      system.disk_usage_percent,
      getHealthStatus('disk', system.disk_usage_percent)
    );
    section.appendChild(diskMetric);

    // System Uptime
    const uptimeDiv = document.createElement('div');
    uptimeDiv.className = 'metric-simple';
    uptimeDiv.innerHTML = `
      <span class="metric-label">System Uptime</span>
      <span class="metric-value">${formatUptime(system.system_uptime_seconds)}</span>
    `;
    section.appendChild(uptimeDiv);

    // App Uptime
    const appUptimeDiv = document.createElement('div');
    appUptimeDiv.className = 'metric-simple';
    appUptimeDiv.innerHTML = `
      <span class="metric-label">App Uptime</span>
      <span class="metric-value">${formatUptime(system.app_uptime_seconds)}</span>
    `;
    section.appendChild(appUptimeDiv);

    return section;
  }

  createEventStatisticsSection(events) {
    const section = document.createElement('section');
    section.className = 'metrics-section';
    section.setAttribute('aria-label', 'Event Statistics');

    const header = document.createElement('h3');
    header.textContent = 'Event Statistics';
    section.appendChild(header);

    // Total Events
    const totalDiv = document.createElement('div');
    totalDiv.className = 'metric-simple';
    totalDiv.innerHTML = `
      <span class="metric-label">Total Events</span>
      <span class="metric-value">${formatNumber(events.total_events)}</span>
    `;
    section.appendChild(totalDiv);

    // Events Today
    const todayDiv = document.createElement('div');
    todayDiv.className = 'metric-simple';
    todayDiv.innerHTML = `
      <span class="metric-label">Events Today</span>
      <span class="metric-value">${formatNumber(events.events_today)}</span>
    `;
    section.appendChild(todayDiv);

    // Events This Hour
    const hourDiv = document.createElement('div');
    hourDiv.className = 'metric-simple';
    hourDiv.innerHTML = `
      <span class="metric-label">Events This Hour</span>
      <span class="metric-value">${formatNumber(events.events_this_hour)}</span>
    `;
    section.appendChild(hourDiv);

    // Detection Rate (with trend)
    const trend = this.getTrendIndicator(
      events.events_per_hour_avg,
      events.events_per_hour_previous
    );
    const rateDiv = document.createElement('div');
    rateDiv.className = 'metric-simple';
    rateDiv.innerHTML = `
      <span class="metric-label">Detection Rate</span>
      <span class="metric-value">${events.events_per_hour_avg.toFixed(1)}/hr ${trend}</span>
    `;
    section.appendChild(rateDiv);

    return section;
  }

  createCameraActivitySection(cameras) {
    const section = document.createElement('section');
    section.className = 'metrics-section';
    section.setAttribute('aria-label', 'Camera Activity');

    const header = document.createElement('h3');
    header.textContent = 'Camera Activity';
    section.appendChild(header);

    cameras.forEach(camera => {
      const cameraDiv = document.createElement('div');
      cameraDiv.className = 'camera-metric';

      const status = this.getCameraStatus(camera.last_event_time);
      const statusDot = `<span class="status-dot ${status}"></span>`;

      const lastSeen = camera.last_event_time
        ? this.formatLastSeen(camera.last_event_time)
        : 'No events';

      cameraDiv.innerHTML = `
        ${statusDot}
        <div class="camera-info">
          <div class="camera-name">${camera.camera_id}</div>
          <div class="camera-stats">
            ${formatNumber(camera.event_count)} events • ${lastSeen}
          </div>
        </div>
      `;

      section.appendChild(cameraDiv);
    });

    return section;
  }

  createMetric(label, value, percentage, status) {
    const metricDiv = document.createElement('div');
    metricDiv.className = 'metric-with-bar';
    metricDiv.setAttribute('role', 'progressbar');
    metricDiv.setAttribute('aria-label', `${label}: ${value}, status ${status}`);
    metricDiv.setAttribute('aria-valuenow', Math.round(percentage));
    metricDiv.setAttribute('aria-valuemin', '0');
    metricDiv.setAttribute('aria-valuemax', '100');

    const statusDot = `<span class="status-dot ${status}"></span>`;

    metricDiv.innerHTML = `
      <div class="metric-header">
        ${statusDot}
        <span class="metric-label">${label}</span>
        <span class="metric-value">${value}</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill ${status}" style="width: ${percentage}%"></div>
      </div>
    `;

    return metricDiv;
  }

  createDiskWarning(diskUsagePercent) {
    const warning = document.createElement('div');
    warning.className = 'alert alert-danger';
    warning.setAttribute('role', 'alert');
    warning.setAttribute('aria-live', 'assertive');

    warning.innerHTML = `
      <div class="alert-icon">⚠️</div>
      <div class="alert-content">
        <strong>Low disk space</strong>
        <p>${diskUsagePercent.toFixed(0)}% used. Clear old recordings to free space.</p>
      </div>
    `;

    return warning;
  }

  getTrendIndicator(current, previous) {
    if (!previous || previous === 0) return '';

    const change = ((current - previous) / previous) * 100;

    if (change > 10) {
      return '<span class="trend trend-up" aria-label="increasing">↑</span>';
    } else if (change < -10) {
      return '<span class="trend trend-down" aria-label="decreasing">↓</span>';
    } else {
      return '<span class="trend trend-stable" aria-label="stable">→</span>';
    }
  }

  getCameraStatus(lastEventTime) {
    if (!lastEventTime) return 'offline';

    const now = new Date();
    const lastEvent = new Date(lastEventTime);
    const minutesSince = (now - lastEvent) / (1000 * 60);

    if (minutesSince < 5) return 'active';   // Green
    if (minutesSince < 60) return 'idle';    // Yellow
    return 'offline';                         // Red
  }

  formatLastSeen(timestamp) {
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;
    const diffMinutes = Math.floor(diffMs / (1000 * 60));

    if (diffMinutes < 1) return 'just now';
    if (diffMinutes < 60) return `${diffMinutes}m ago`;

    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours}h ago`;

    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays}d ago`;
  }

  updateLastUpdated() {
    let lastUpdated = this.container.querySelector('.last-updated');

    if (!lastUpdated) {
      lastUpdated = document.createElement('div');
      lastUpdated.className = 'last-updated';
      this.container.appendChild(lastUpdated);
    }

    const now = new Date();
    lastUpdated.textContent = `Updated: ${now.toLocaleTimeString()}`;
    lastUpdated.setAttribute('aria-live', 'polite');
  }

  renderStaleDataWarning() {
    // Show existing data with stale warning
    if (this.lastMetrics) {
      this.render(this.lastMetrics);

      // Add stale data warning
      const warning = document.createElement('div');
      warning.className = 'alert alert-warning';
      warning.innerHTML = `
        <div class="alert-icon">⚠️</div>
        <div class="alert-content">
          <strong>Connection issue</strong>
          <p>Showing cached data. <button class="btn-retry" onclick="window.metricsPanel.fetchAndRenderMetrics()">Retry</button></p>
        </div>
      `;
      this.container.insertBefore(warning, this.container.firstChild);
    }
  }

  showError() {
    this.container.innerHTML = `
      <div class="error-state">
        <div class="error-icon">⚠️</div>
        <h3>Unable to load metrics</h3>
        <p>The metrics endpoint is not responding.</p>
        <button class="btn-retry" onclick="window.metricsPanel.fetchAndRenderMetrics()">Retry</button>
      </div>
    `;
  }

  destroy() {
    console.log('[MetricsPanel] Destroying...');
    this.stopPolling();
  }
}

export default MetricsPanel;
```

**Verification:**
```javascript
// Browser console
import MetricsPanel from './components/MetricsPanel.js';

const metricsPanel = new MetricsPanel('.metrics-panel');
await metricsPanel.init();

// Should see metrics displayed
// Check console for polling logs every 5 seconds
```

---

### Step 5: Add CSS Styles (30 minutes)

**File:** `web/css/components.css`

**Purpose:** Style metrics panel, progress bars, status dots, alerts

**Implementation:**

```css
/* web/css/components.css - Metrics Panel Additions */

/* Metrics Panel Container */
.metrics-panel {
  grid-area: metrics;
  width: 320px;
  background: var(--bg-secondary);
  border-left: 1px solid var(--bg-tertiary);
  padding: var(--spacing-lg);
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
}

/* Metrics Section */
.metrics-section {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-md);
}

.metrics-section h3 {
  font-size: var(--font-size-lg);
  color: var(--text-primary);
  margin: 0;
  padding-bottom: var(--spacing-sm);
  border-bottom: 1px solid var(--bg-tertiary);
}

/* Metric with Progress Bar */
.metric-with-bar {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.metric-header {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

.metric-label {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  flex: 1;
}

.metric-value {
  font-size: var(--font-size-sm);
  color: var(--text-primary);
  font-weight: 600;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--bg-tertiary);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  transition: width var(--transition-normal);
  border-radius: var(--radius-sm);
}

.progress-fill.healthy {
  background: var(--accent-success);
}

.progress-fill.warning {
  background: var(--accent-warning);
}

.progress-fill.critical {
  background: var(--accent-error);
}

/* Simple Metric (no progress bar) */
.metric-simple {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--spacing-xs) 0;
}

/* Status Dots */
.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.status-dot.healthy,
.status-dot.active {
  background: var(--accent-success);
  box-shadow: 0 0 4px var(--accent-success);
}

.status-dot.warning,
.status-dot.idle {
  background: var(--accent-warning);
  box-shadow: 0 0 4px var(--accent-warning);
}

.status-dot.critical,
.status-dot.offline {
  background: var(--accent-error);
  box-shadow: 0 0 4px var(--accent-error);
}

/* Camera Metric */
.camera-metric {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding: var(--spacing-sm);
  background: var(--bg-tertiary);
  border-radius: var(--radius-sm);
  transition: background var(--transition-fast);
}

.camera-metric:hover {
  background: var(--bg-primary);
}

.camera-info {
  flex: 1;
}

.camera-name {
  font-size: var(--font-size-base);
  color: var(--text-primary);
  font-weight: 600;
}

.camera-stats {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  margin-top: 2px;
}

/* Trend Indicators */
.trend {
  font-size: var(--font-size-sm);
  font-weight: bold;
  margin-left: var(--spacing-xs);
}

.trend-up {
  color: var(--accent-warning);
}

.trend-down {
  color: var(--accent-success);
}

.trend-stable {
  color: var(--text-secondary);
}

/* Alerts */
.alert {
  display: flex;
  gap: var(--spacing-sm);
  padding: var(--spacing-md);
  border-radius: var(--radius-md);
  margin-bottom: var(--spacing-md);
}

.alert-danger {
  background: rgba(244, 67, 54, 0.1);
  border: 1px solid var(--accent-error);
}

.alert-warning {
  background: rgba(255, 152, 0, 0.1);
  border: 1px solid var(--accent-warning);
}

.alert-icon {
  font-size: 24px;
}

.alert-content {
  flex: 1;
}

.alert-content strong {
  display: block;
  margin-bottom: var(--spacing-xs);
}

.alert-danger .alert-content strong {
  color: var(--accent-error);
}

.alert-warning .alert-content strong {
  color: var(--accent-warning);
}

.alert-content p {
  margin: 0;
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
}

/* Retry Button (in alerts) */
.btn-retry {
  padding: var(--spacing-xs) var(--spacing-sm);
  background: var(--accent-primary);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: var(--font-size-sm);
  transition: background var(--transition-fast);
}

.btn-retry:hover {
  background: var(--accent-primary-dark);
}

/* Last Updated */
.last-updated {
  font-size: var(--font-size-xs);
  color: var(--text-tertiary);
  text-align: center;
  padding-top: var(--spacing-sm);
  border-top: 1px solid var(--bg-tertiary);
  margin-top: auto;
}

/* Error State */
.error-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xxl);
  text-align: center;
}

.error-state .error-icon {
  font-size: 48px;
  margin-bottom: var(--spacing-md);
}

.error-state h3 {
  color: var(--accent-error);
  margin-bottom: var(--spacing-sm);
}

.error-state p {
  color: var(--text-secondary);
  margin-bottom: var(--spacing-md);
}

/* Responsive */
@media (max-width: 1280px) {
  .metrics-panel {
    width: 280px;
  }
}

@media (max-width: 1024px) {
  .metrics-panel {
    position: fixed;
    right: -320px;
    top: 60px;
    bottom: 0;
    z-index: 90;
    transition: right var(--transition-normal);
    box-shadow: -4px 0 12px rgba(0, 0, 0, 0.3);
  }

  .metrics-panel.open {
    right: 0;
  }
}
```

---

### Step 6: Update app.js to Initialize MetricsPanel (10 minutes)

**File:** `web/js/app.js`

**Purpose:** Initialize MetricsPanel on dashboard load

**Implementation:**

```javascript
// web/js/app.js (additions to existing file)

import MetricsPanel from './components/MetricsPanel.js';

class App {
  constructor() {
    this.wsClient = null;
    this.eventFeed = null;
    this.metricsPanel = null; // NEW
  }

  async init() {
    console.log('[App] Initializing dashboard...');

    try {
      // Initialize event feed component (from Story 5.5)
      this.eventFeed = new EventFeed('.main-content');
      await this.eventFeed.loadInitialEvents();

      // Connect to WebSocket for real-time updates (from Story 5.5)
      this.wsClient = new WebSocketClient('ws://localhost:8000/ws/events', eventStore);
      this.wsClient.connect();

      // Initialize metrics panel (NEW)
      this.metricsPanel = new MetricsPanel('.metrics-panel');
      await this.metricsPanel.init();

      // Subscribe to connection status for header update (from Story 5.5)
      eventStore.subscribe((state) => {
        this.updateConnectionStatus(state.connectionStatus);
        this.updateEventCount(state.eventCount);
      });

      console.log('[App] Dashboard ready');
    } catch (error) {
      console.error('[App] Initialization failed:', error);
    }
  }

  // ... existing methods ...

  destroy() {
    console.log('[App] Shutting down...');
    if (this.wsClient) this.wsClient.disconnect();
    if (this.eventFeed) this.eventFeed.destroy();
    if (this.metricsPanel) this.metricsPanel.destroy(); // NEW
  }
}

// ... existing initialization code ...

// Expose metricsPanel for debugging
window.metricsPanel = null;

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    const app = new App();
    app.init();
    window.app = app;
    window.metricsPanel = app.metricsPanel; // NEW
  });
} else {
  const app = new App();
  app.init();
  window.app = app;
  window.metricsPanel = app.metricsPanel; // NEW
}
```

---

### Step 7: Manual Testing (30 minutes)

**Test 1: System Metrics Display**

```bash
# Start web server
python web_server.py

# Open http://localhost:8000
# Verify metrics panel shows:
# - CPU Usage (with progress bar)
# - Memory Usage (with progress bar)
# - Disk Usage (with progress bar)
# - System Uptime
# - App Uptime

# Compare with system monitor (Activity Monitor on macOS, Task Manager on Windows)
```

**Test 2: Auto-Update Every 5 Seconds**

```bash
# Open browser DevTools > Console
# Should see: "[MetricsPanel] Starting polling (every 5s)"

# Open DevTools > Network tab
# Filter by "metrics"
# Should see request every 5 seconds

# Start CPU-intensive task
# CPU usage should update within 5 seconds
```

**Test 3: Event Statistics**

```bash
# Check database
sqlite3 surveillance.db "SELECT COUNT(*) FROM events;"
# Compare with "Total Events" in metrics panel

# Check today's events
sqlite3 surveillance.db "SELECT COUNT(*) FROM events WHERE DATE(timestamp) = DATE('now');"
# Compare with "Events Today"
```

**Test 4: Camera Activity**

```bash
# Trigger motion on Camera 1
# Verify "Last Event" timestamp updates for Camera 1
# Verify status dot is green (active)

# Wait 5+ minutes without motion
# Status dot should turn yellow (idle)
```

**Test 5: Visual Health Indicators**

```python
# Simulate high CPU usage (Python)
import multiprocessing
def burn_cpu():
    while True:
        pass

for _ in range(multiprocessing.cpu_count()):
    multiprocessing.Process(target=burn_cpu).start()

# Check metrics panel
# CPU progress bar should be red
# Status dot should be red
```

**Test 6: Page Visibility (Pause Polling)**

```bash
# Open dashboard
# Open browser console
# Switch to another tab
# Console should show: "[MetricsPanel] Tab hidden, pausing polling"

# Switch back to dashboard tab
# Console should show: "[MetricsPanel] Tab visible, resuming polling"
```

**Test 7: Error Handling**

```bash
# Stop web server (Ctrl+C)
# Wait 5 seconds (next poll)
# Verify error message: "Unable to load metrics"
# Verify "Retry" button present

# Restart web server
# Click "Retry" button
# Metrics should load
```

---

## Common Issues and Solutions

### Issue 1: Metrics Not Loading

**Symptom:** Metrics panel shows error: "Unable to load metrics"

**Diagnosis:**
```bash
# Check endpoint
curl http://localhost:8000/api/metrics

# If fails, check web server logs
python web_server.py
# Look for errors in terminal
```

**Solution:**
- Verify Story 5.2 `/api/metrics` endpoint is implemented
- Verify web server is running
- Check database exists: `ls -lh surveillance.db`

---

### Issue 2: Polling Not Working

**Symptom:** Metrics never update after initial load

**Diagnosis:**
```javascript
// Browser console
window.metricsPanel.pollInterval
// Should be a number (interval ID)

// If null, polling not started
```

**Solution:**
```javascript
// Browser console
window.metricsPanel.startPolling();

// Check console for "[MetricsPanel] Starting polling (every 5s)"
```

---

### Issue 3: Progress Bars Not Colored

**Symptom:** Progress bars are gray instead of green/yellow/red

**Diagnosis:**
```javascript
// Browser console
import { getHealthStatus } from './utils/healthIndicators.js';
getHealthStatus('cpu', 95);
// Should return "critical"
```

**Solution:**
- Verify `getHealthStatus()` function is working
- Check CSS classes: `.progress-fill.healthy`, `.progress-fill.warning`, `.progress-fill.critical`
- Inspect element: progress fill should have class like `progress-fill critical`

---

### Issue 4: Memory Leak (Polling Continues on Hidden Tab)

**Symptom:** Polling continues even when tab is hidden

**Diagnosis:**
```javascript
// Browser console
document.addEventListener('visibilitychange', () => {
  console.log('Visibility changed:', document.hidden);
});

// Switch tabs
// Should see log: "Visibility changed: true"
```

**Solution:**
- Verify `setupVisibilityListener()` is called in constructor
- Check `this.isVisible` flag is respected in `setInterval` callback

---

### Issue 5: Trend Indicators Not Showing

**Symptom:** Detection rate shows no trend arrow (↑ ↓ →)

**Diagnosis:**
```javascript
// Browser console
const metrics = await window.metricsPanel.apiClient.getMetrics();
console.log({
  current: metrics.events.events_per_hour_avg,
  previous: metrics.events.events_per_hour_previous
});

// If previous is 0 or null, trend won't show
```

**Solution:**
- Ensure backend `/api/metrics` returns `events_per_hour_previous` value
- Verify Story 5.2 implementation includes trend calculation

---

## Performance Optimization

### 1. Pause Polling When Tab Hidden

Already implemented with Page Visibility API:

```javascript
if (this.isVisible) {
  this.fetchAndRenderMetrics();
} else {
  console.log('[MetricsPanel] Tab hidden, skipping poll');
}
```

### 2. Cache Last Metrics (Stale Data Fallback)

Already implemented:

```javascript
this.lastMetrics = metrics; // Store for stale data fallback
```

### 3. Efficient DOM Updates

Only update changed values (future enhancement):

```javascript
// Instead of re-rendering entire panel, update only changed values
document.querySelector('.cpu-value').textContent = formatPercentage(cpu);
```

---

## Accessibility Checklist

- [ ] Semantic HTML (`<section>`, `<h3>`, etc.)
- [ ] ARIA labels for progress bars
- [ ] `aria-live="polite"` for metric updates
- [ ] Keyboard navigation (Tab through metrics)
- [ ] Screen reader announces metric values
- [ ] WCAG AA contrast ratios (4.5:1)

**Verification:**
```bash
# Enable screen reader (VoiceOver, NVDA)
# Navigate to metrics panel
# Tab through metrics
# Should hear: "CPU Usage: 45%, healthy" etc.
```

---

## Deployment Checklist

- [ ] `healthIndicators.js` created and tested
- [ ] `formatters.js` updated with new formatters
- [ ] `MetricsPanel.js` created and tested
- [ ] CSS styles added to `components.css`
- [ ] `app.js` updated to initialize MetricsPanel
- [ ] Manual tests completed (7 test cases)
- [ ] Browser console shows no errors
- [ ] Metrics update every 5 seconds
- [ ] Page Visibility API working (pause on hidden)
- [ ] Health indicators working (green/yellow/red)
- [ ] Responsive design tested (desktop, tablet)

---

## Next Steps

After completing Story 5.6:

1. **Story 5.7: Event Detail Modal** - Click event cards to see full details
2. **Story 5.8: Search and Filtering** - Filter events by camera, time range, objects

---

## Related Documentation

- **Story Document:** `docs/stories/5.6.story.md`
- **Story 5.2:** Event API Endpoints (`/api/metrics`)
- **Story 5.4:** Dashboard HTML/CSS Framework
- **Story 5.5:** Event Feed Component

---

## Change Log

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-11-10 | 1.0 | Initial implementation guide | Winston (Architect) |

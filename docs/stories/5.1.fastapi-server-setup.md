# Story 5.1: FastAPI Server Setup

**Status:** Draft

**Story:**
**As a** developer,
**I want** a FastAPI web server integrated with the main application,
**so that** I can serve the dashboard and provide API endpoints.

**Acceptance Criteria:**

1. FastAPI server starts when `--web` flag is provided to main.py
2. Server runs on configurable port (default: 8080)
3. Basic health check endpoint responds at `/api/health`
4. Static file serving configured for dashboard assets
5. Server integrates cleanly with existing signal handling
6. CORS configured for local development
7. Server shuts down gracefully with main application

**Tasks / Subtasks:**

- [ ] Task 1: Add FastAPI and Uvicorn dependencies
  - [ ] Add `fastapi` and `uvicorn` to requirements.txt
  - [ ] Update pyproject.toml with web dependencies
  - [ ] Test dependency installation

- [ ] Task 2: Create API server module structure
  - [ ] Create `api/` directory in project root
  - [ ] Create `api/__init__.py`
  - [ ] Create `api/server.py` with FastAPI application
  - [ ] Create `api/routes/` directory for endpoint organization

- [ ] Task 3: Implement basic FastAPI application
  - [ ] Initialize FastAPI app with title and version
  - [ ] Add CORS middleware for local development
  - [ ] Configure static file serving for `web/` directory
  - [ ] Add basic `/api/health` endpoint returning system status

- [ ] Task 4: Integrate server with main application
  - [ ] Add `--web` command line argument to main.py
  - [ ] Add `--port` option for configurable port
  - [ ] Modify main.py to start web server when `--web` flag present
  - [ ] Ensure server runs in background thread alongside main processing

- [ ] Task 5: Implement graceful shutdown integration
  - [ ] Ensure web server shuts down cleanly on SIGINT/SIGTERM
  - [ ] Add server shutdown to existing signal handling sequence
  - [ ] Test server stops within shutdown timeout (10 seconds)

- [ ] Task 6: Add comprehensive logging
  - [ ] Server startup/shutdown events logged
  - [ ] API request/response logging with timing
  - [ ] Error handling with appropriate HTTP status codes
  - [ ] Integration with existing logging configuration

- [ ] Task 7: Create unit tests
  - [ ] Test server initialization and configuration
  - [ ] Test health endpoint functionality
  - [ ] Test static file serving
  - [ ] Test CORS configuration

- [ ] Task 8: Create integration tests
  - [ ] Test server starts with `--web` flag
  - [ ] Test server responds on configured port
  - [ ] Test server shutdown with main application
  - [ ] Test concurrent operation with video processing

**Dev Notes:**

**Previous Story Insights:**
- Story 4.5 completed signal handling with graceful shutdown
- Main application has established patterns for CLI arguments and component integration
- Logging configuration established with structured logging
- Dependency management follows existing patterns

**Technical Specifications:**
- Use FastAPI for async web framework with automatic OpenAPI documentation
- Server should run on separate thread to not block main processing loop
- Default port 8080, configurable via `--port` option
- CORS allow all origins for localhost development
- Static files served from `web/` directory (to be created in future stories)

**API Design:**
- `/api/health` - GET endpoint returning system status
- Future endpoints: `/api/events`, `/api/metrics`, `/api/stream`
- JSON responses with consistent error format
- Standard HTTP status codes (200, 400, 404, 500)

**Testing Strategy:**
- Unit tests for individual components and endpoints
- Integration tests for full server lifecycle
- Manual testing with curl/browser for basic functionality
- Load testing to ensure no impact on main processing performance

**Dependencies:**
- FastAPI and Uvicorn packages
- Integration with existing signal handling (core/signals.py)
- Access to system health information for `/api/health` endpoint

**Risk Assessment:**
- **Medium:** Threading complexity with main processing loop
- **Low:** FastAPI is well-established framework
- **Low:** Static file serving is basic FastAPI feature

**Definition of Done:**
- [ ] Server starts successfully with `--web` flag
- [ ] Health endpoint responds with 200 status
- [ ] Static file serving configured
- [ ] Graceful shutdown works with main application
- [ ] All unit and integration tests pass
- [ ] Code reviewed and follows project conventions
- [ ] Documentation updated in README.md
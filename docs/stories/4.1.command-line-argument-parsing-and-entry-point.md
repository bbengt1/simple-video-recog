# Story 4.1: Command-Line Argument Parsing and Entry Point

**Status:** Done

**Story:**
**As a** developer,
**I want** a professional CLI interface with standard arguments (--help, --config, --version, --dry-run),
**so that** the system is easy to use, configure, and validate before running in production.

**Acceptance Criteria:**

1. CLI entry point implemented as `main.py` with main() function
2. Argument parsing using argparse library with following options:
   - `--config PATH` or `-c PATH`: Path to YAML configuration file (default: config/config.yaml)
   - `--dry-run`: Validate configuration and connectivity without starting processing loop
   - `--version` or `-v`: Display version and build information
   - `--help` or `-h`: Display usage instructions and examples
   - `--log-level LEVEL`: Override logging level (DEBUG, INFO, WARNING, ERROR)
   - `--metrics-interval SECONDS`: Override metrics display interval (default: 60)
3. Help text includes:
   - Usage: `python main.py [OPTIONS]`
   - Description: "Local Video Recognition System - Motion detection with CoreML object detection and Ollama LLM semantic understanding"
   - Examples: `python main.py --config cameras/front-door.yaml --dry-run`
   - Exit codes: 0=success, 1=error, 2=config invalid, 3=storage full
4. Version output format: `video-recog v1.0.0 (build 2025-11-08) - Python 3.10.12 - macOS 14.2`
5. Config file validation: If --config path doesn't exist, exit with error code 2 and message
6. Argument validation: Invalid --log-level value shows error and available options
7. Entry point callable via: `python main.py` or `python -m video_recog` (package mode)
8. Shebang support: `#!/usr/bin/env python3` allows direct execution (`./main.py`)
9. Exit code consistency: All exit paths use defined exit codes (documented in README)
10. Unit tests verify: argument parsing, default values, validation logic, help text generation
11. Integration test: Launch with each argument combination, verify expected behavior
12. Manual test: Run --help and verify output is clear and accurate

**Tasks / Subtasks:**

- [x] Task 1: Implement argparse-based CLI argument parsing (AC: 1, 2, 3, 5, 6, 7, 8)
  - [x] Update main.py to use argparse.ArgumentParser instead of current basic parsing
  - [x] Add --config/-c argument with default path config/config.yaml
  - [x] Add --dry-run flag for validation-only mode
  - [x] Add --version/-v flag for version display
  - [x] Add --help/-h flag (automatic with argparse)
  - [x] Add --log-level argument with validation (DEBUG, INFO, WARNING, ERROR)
  - [x] Add --metrics-interval argument with integer validation
  - [x] Implement config file existence validation with exit code 2
  - [x] Add shebang line #!/usr/bin/env python3 for direct execution
  - [x] Update help text with usage, description, examples, and exit codes
- [x] Task 2: Implement version information display (AC: 4)
  - [x] Create core/version.py module with get_version_info() function
  - [x] Define VERSION, BUILD_DATE, GIT_COMMIT constants
  - [x] Implement VersionInfo Pydantic model for structured version data
  - [x] Collect runtime information (Python version, platform, dependencies)
  - [x] Format version output as specified in AC4
  - [x] Integrate --version flag with version display logic
- [x] Task 3: Implement exit code consistency and error handling (AC: 9)
  - [x] Define exit code constants (0=success, 1=error, 2=config invalid, 3=storage full)
  - [x] Update all sys.exit() calls to use defined exit codes
  - [x] Implement proper error handling for config validation failures
  - [x] Ensure consistent error message formatting
- [x] Task 4: Create unit tests for CLI functionality (AC: 10)
  - [x] Create tests/unit/test_cli.py for argument parsing tests
  - [x] Test argument parsing with various combinations
  - [x] Test default values for optional arguments
  - [x] Test validation logic for --log-level and --config
  - [x] Test help text generation and formatting
  - [x] Test version information collection and formatting
  - [x] Mock file system operations for config validation
- [x] Task 5: Create integration tests for CLI execution (AC: 11)
  - [x] Create tests/integration/test_cli_execution.py
  - [x] Test --help flag displays correct usage information
  - [x] Test --version flag displays version information
  - [x] Test --config with valid and invalid paths
  - [x] Test --dry-run flag execution (requires health check integration)
  - [x] Test --log-level validation and override
  - [x] Test --metrics-interval validation
  - [x] Test exit codes for various failure scenarios
- [x] Task 6: Manual testing and documentation updates (AC: 12)
  - [x] Run --help manually and verify clarity and completeness
  - [x] Test direct execution with ./main.py (requires executable permissions)
  - [x] Test package mode execution python -m video_recog
  - [x] Update README.md with CLI usage examples
  - [x] Document exit codes in README troubleshooting section

**Dev Notes:**

**Previous Story Insights:**
Story 3.3 implemented comprehensive database query functionality with proper error handling and performance monitoring. The main.py entry point currently exists but uses basic argument parsing that needs to be upgraded to professional CLI standards. [Source: docs/stories/3.3.event-query-and-retrieval-api.md]

**Data Models:**
No specific data models required for CLI functionality - uses standard Python argparse and pathlib for file operations. Version information will use Pydantic BaseModel for structured data. [Source: docs/architecture/models.md]

**API Specifications:**
CLI provides command-line interface only - no REST API requirements for this story. Focus on argparse.ArgumentParser usage with proper help text and validation. [Source: docs/architecture/python-code-style.md]

**Component Specifications:**
CLI entry point serves as main application entry point. Requires integration with existing config loading, logging setup, and health check systems. Version display needs to collect runtime dependency information. [Source: docs/architecture/repository-structure.md]

**File Locations:**
- main.py: Primary CLI entry point in project root [Source: docs/architecture/repository-structure.md]
- core/version.py: New module for version information collection [Source: docs/architecture/repository-structure.md]
- tests/unit/test_cli.py: Unit tests for CLI argument parsing [Source: docs/architecture/testing-pyramid.md]
- tests/integration/test_cli_execution.py: Integration tests for CLI execution [Source: docs/architecture/testing-pyramid.md]

**Testing Requirements:**
Unit tests for argument parsing logic with mocked file system operations. Integration tests for actual CLI execution with subprocess calls. Manual testing for help text clarity and direct execution. Test coverage ≥70% for new CLI modules. [Source: docs/architecture/testing-pyramid.md, docs/architecture/unit-test-best-practices.md]

**Technical Constraints:**
Python 3.10+ required for full argparse functionality. CLI must work on macOS with shebang support. Version information collection requires runtime inspection of dependencies. Exit codes must be consistent across all error paths. [Source: docs/architecture/technology-stack-table.md]

**Code Organization Patterns:**
Follow PEP 8 with 100 character line limits. Use Google-style docstrings for all functions. Import organization: standard library, third-party, local imports. Use pathlib for file operations. [Source: docs/architecture/python-code-style.md, docs/architecture/code-organization-patterns.md]

**Testing:**
- Test file location: tests/unit/test_cli.py for unit tests, tests/integration/test_cli_execution.py for integration tests
- Test standards: pytest framework, ≥70% coverage, mock external dependencies
- Testing frameworks and patterns: pytest fixtures for test data, parametrized tests for argument combinations
- Specific testing requirements: Test argument parsing, validation logic, help text, version display, exit codes

**Change Log:**

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-09 | 1.0 | Initial story creation for Epic 4 CLI interface | Scrum Master |
| 2025-11-09 | 1.1 | Story approved for development - ready for implementation | Product Owner |
| 2025-11-09 | 1.2 | Story completed - professional CLI interface implemented with full testing | Developer |
| 2025-11-09 | 1.3 | QA review completed - all acceptance criteria validated, story approved for completion | QA Agent |

**Dev Agent Record:**

**Agent Model Used:**
GitHub Copilot

**Debug Log References:**
- Test hanging issue resolved by properly mocking all component instantiations in dry-run test
- CoreML warnings are expected in test environment and don't affect functionality

**Completion Notes List:**
- All acceptance criteria met with comprehensive argparse implementation
- Version display includes runtime Python and platform information
- Exit codes properly defined and used consistently
- Unit tests cover all argument parsing scenarios with proper mocking
- Integration tests validate actual CLI execution
- Manual testing confirms --help, --version, and error handling work correctly

**File List:**
- main.py: Updated with professional argparse CLI interface
- core/version.py: New module for version information collection and formatting
- tests/unit/test_cli.py: Comprehensive unit tests for CLI functionality
- tests/integration/test_cli_execution.py: Integration tests for CLI execution

**QA Results:**
✅ **APPROVED FOR COMPLETION**

All acceptance criteria validated and verified:
- CLI arguments parse correctly with proper defaults and validation
- Version display shows expected format with runtime information
- Config validation exits with code 2 for invalid files
- Help text is clear and comprehensive
- Unit tests pass (191/191) with proper mocking
- Integration tests pass (58/58) with comprehensive coverage
- Manual testing confirms functionality works as expected

**QA Approval:** Story 4.1 meets all acceptance criteria and is ready for production deployment.

---

**Story Draft Validation Report**

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | Clear professional CLI requirements for production use |
| 2. Technical Implementation Guidance | PASS   | Specific argparse options, validation logic, and file locations identified |
| 3. Reference Effectiveness           | PASS   | Architecture documents referenced for code style, testing, and structure |
| 4. Self-Containment Assessment       | PASS   | All technical details included with source references, no external research needed |
| 5. Testing Guidance                  | PASS   | Unit and integration test approaches specified with specific test scenarios |

**Final Assessment: READY**

The story provides comprehensive context for implementing professional CLI argument parsing. All acceptance criteria are clearly defined, technical requirements are well-specified with architecture references, and the developer has sufficient information to proceed without additional research. The story builds appropriately on previous CLI foundation while establishing production-ready command-line interface standards.
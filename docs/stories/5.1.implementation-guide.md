# Story 5.1: FastAPI Server Setup - Implementation Guide

**Quick Reference for Developers**

---

## üéØ Story Overview

**Goal:** Create a FastAPI web server that serves the dashboard and provides REST API endpoints.

**Effort:** 5-7 hours (1 day)

**Priority:** HIGH (Blocks all other Epic 5 stories)

---

## üìã Pre-Implementation Checklist

Before you start, verify:

- [ ] Epic 4 is complete (all 9 stories Done)
- [ ] Database migration 003 has been applied
  ```bash
  sqlite3 data/events.db < migrations/003_add_api_indexes.sql
  ```
- [ ] Database schema version is 3+
  ```bash
  sqlite3 data/events.db "SELECT version FROM schema_version"
  ```
- [ ] Python packages installed
  ```bash
  pip install fastapi uvicorn[standard] python-multipart
  ```

---

## üöÄ Quick Start (TDD Approach)

### 1. Create Directory Structure (5 min)

```bash
# Create API directories
mkdir -p api/routes
touch api/__init__.py
touch api/app.py
touch api/routes/__init__.py
touch api/routes/health.py
touch api/dependencies.py
touch api/models.py

# Create web directories (already exists)
mkdir -p web/css web/js

# Create entry point
touch web_server.py
```

### 2. Install Dependencies (2 min)

```bash
pip install fastapi==0.104.1 uvicorn[standard]==0.24.0 python-multipart==0.0.6
pip freeze > requirements.txt
```

### 3. Write Tests First (30 min)

```bash
mkdir -p tests/api
touch tests/api/__init__.py
touch tests/api/test_health.py
touch tests/api/test_dependencies.py
```

Copy test code from `docs/stories/5.1.story.md` section "Testing Requirements"

Run tests (should fail):
```bash
pytest tests/api/ -v
```

### 4. Implement Core Components (2-3 hours)

**Order of Implementation:**

1. **Database Dependency** (`api/dependencies.py`)
   - Implement `get_config()`
   - Implement `get_db_connection()` with read-only mode
   - Test: `pytest tests/api/test_dependencies.py`

2. **Health Check Endpoint** (`api/routes/health.py`)
   - Create Pydantic response model
   - Implement health check logic
   - Test: `pytest tests/api/test_health.py::test_health_check_success`

3. **FastAPI Application** (`api/app.py`)
   - Create application factory `create_app()`
   - Add CORS middleware
   - Include health router
   - Mount static file directories
   - Test: `pytest tests/api/test_health.py`

4. **Web Server Entry Point** (`web_server.py`)
   - Add logging setup
   - Add configuration loading
   - Add database validation
   - Add uvicorn configuration
   - Test: Manual startup

### 5. Manual Testing (30 min)

```bash
# Terminal 1: Start web server
python web_server.py

# Terminal 2: Test endpoints
curl http://localhost:8000/api/health
curl http://localhost:8000/docs
curl http://localhost:8000/

# Browser: Open http://localhost:8000
```

### 6. Documentation (30 min)

Update README.md with:
- Web server startup instructions
- Port configuration
- Development mode usage

---

## üîß Implementation Details

### Critical: Read-Only Database Connection

```python
# api/dependencies.py
_db_conn = sqlite3.connect(
    f"file:{db_path}?mode=ro",  # ‚Üê CRITICAL: Read-only mode
    uri=True,
    check_same_thread=False
)
```

**Why?** Prevents write contention with main.py video processing pipeline.

**Test:**
```python
# Should succeed
cursor.execute("SELECT * FROM events LIMIT 1")

# Should fail with exception
cursor.execute("INSERT INTO events ...")
```

### Critical: Localhost-Only Binding

```python
# web_server.py
uvicorn.run(
    "api.app:app",
    host="127.0.0.1",  # ‚Üê CRITICAL: Localhost only
    port=8000
)
```

**Why?** Security requirement (NFR32) - no external access in Phase 2.

### Critical: CORS Configuration

```python
# api/app.py
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:8000", "http://127.0.0.1:8000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**Why?** Allows browser-based dashboard to call API endpoints.

---

## ‚úÖ Acceptance Criteria Checklist

Use this checklist to verify story completion:

### AC 1: FastAPI Application Setup
- [ ] `api/app.py` created with `create_app()` factory
- [ ] Server runs on localhost:8000
- [ ] CORS middleware configured
- [ ] OpenAPI docs at http://localhost:8000/docs
- [ ] Health check endpoint functional

### AC 2: Project Structure
- [ ] All files created per directory structure
- [ ] `web_server.py` entry point works
- [ ] Can start independently of `main.py`

### AC 3: Configuration Management
- [ ] Reads from `config/config.yaml`
- [ ] Database path loaded correctly
- [ ] Port configurable via `WEB_PORT` env var
- [ ] Host hardcoded to `127.0.0.1`

### AC 4: Database Connection (Read-Only)
- [ ] Connection uses `mode=ro`
- [ ] Connection shared across requests
- [ ] Error handling if DB missing
- [ ] Dependency injection works

### AC 5: Static File Serving
- [ ] `/` serves `web/index.html`
- [ ] `/css/*` serves CSS files
- [ ] `/js/*` serves JavaScript files
- [ ] `/images/*` serves event images
- [ ] Correct MIME types

### AC 6: Health Check Endpoint
- [ ] `GET /api/health` returns JSON
- [ ] Includes all required fields
- [ ] 200 when healthy, 503 when degraded
- [ ] Response time <50ms

### AC 7: Startup Validation
- [ ] Database existence checked
- [ ] Schema version verified
- [ ] Warning if schema < 3
- [ ] Exit with error if DB missing
- [ ] Startup logs complete

### AC 8: Graceful Shutdown
- [ ] Ctrl+C triggers shutdown
- [ ] SIGTERM handled
- [ ] DB connection closed
- [ ] Shutdown message logged

### AC 9: Error Handling
- [ ] 404 for missing endpoints
- [ ] 500 for server errors
- [ ] CORS errors handled
- [ ] File not found returns 404

### AC 10: Logging Configuration
- [ ] Uses same config as main app
- [ ] Logs to `logs/web_server.log`
- [ ] INFO level for normal ops
- [ ] ERROR level for failures
- [ ] Request logging enabled

### AC 11: Development Mode Support
- [ ] `--reload` flag works
- [ ] `DEV_MODE=1` enables hot reload
- [ ] Debug info in dev mode
- [ ] Production mode default

### AC 12: Documentation
- [ ] README.md updated
- [ ] Architecture diagram added
- [ ] API docs in OpenAPI
- [ ] Troubleshooting section

---

## üß™ Testing Strategy

### Unit Tests (45 min)

**Coverage Target:** >80% for `api/` directory

```bash
pytest tests/api/ --cov=api --cov-report=term-missing
```

**Key Tests:**
- Health check returns 200 with correct JSON
- Health check response time <50ms
- Database connection is read-only
- CORS headers present
- OpenAPI docs accessible

### Integration Tests (30 min)

```bash
pytest tests/integration/test_web_server.py
```

**Key Tests:**
- Web server starts successfully
- Static files served correctly
- API docs accessible
- Graceful shutdown works

### Manual Testing (30 min)

**Checklist:**
- [ ] Start server: `python web_server.py`
- [ ] Access dashboard: http://localhost:8000
- [ ] View API docs: http://localhost:8000/docs
- [ ] Test health endpoint: http://localhost:8000/api/health
- [ ] Verify logs in `logs/web_server.log`
- [ ] Test Ctrl+C shutdown
- [ ] Test port override: `WEB_PORT=8888 python web_server.py`
- [ ] Test dev mode: `python web_server.py --reload`

---

## üö® Common Issues & Solutions

### Issue 1: "Database not found"

**Error:**
```
ERROR: Database not found at data/events.db
Please run the main application first to create the database
```

**Solution:**
```bash
# Run main application to create database
python main.py --dry-run
```

### Issue 2: "Schema version 2 detected"

**Warning:**
```
WARNING: Database schema version 2 detected
Epic 5 requires schema version 3+
Please run migrations/003_add_api_indexes.sql
```

**Solution:**
```bash
sqlite3 data/events.db < migrations/003_add_api_indexes.sql
```

### Issue 3: "Port 8000 already in use"

**Error:**
```
ERROR: [Errno 48] Address already in use
```

**Solution:**
```bash
# Use different port
WEB_PORT=8001 python web_server.py

# Or kill existing process
lsof -ti:8000 | xargs kill
```

### Issue 4: "Cannot write to database"

**Error:**
```
sqlite3.OperationalError: attempt to write a readonly database
```

**Expected Behavior:** This is correct! API should be read-only.

If you see this in logs, it means the read-only connection is working properly.

### Issue 5: "CORS policy blocked"

**Error in browser console:**
```
Access to fetch at 'http://localhost:8000/api/health' from origin 'http://localhost:3000' has been blocked by CORS policy
```

**Solution:**
Check CORS middleware includes the requesting origin:
```python
allow_origins=["http://localhost:8000", "http://localhost:3000"]
```

---

## üìä Success Metrics

Track these metrics during implementation:

| Metric | Target | How to Measure |
|--------|--------|----------------|
| Health check response | <50ms | `curl -w "@curl-format.txt" http://localhost:8000/api/health` |
| Server startup time | <5s | Time from command to "Uvicorn running" log |
| Unit test coverage | >80% | `pytest --cov=api --cov-report=term` |
| Read-only enforcement | 100% | All write attempts should fail |

---

## üéì Learning Resources

**FastAPI:**
- Official docs: https://fastapi.tiangolo.com/
- Tutorial: https://fastapi.tiangolo.com/tutorial/

**Uvicorn:**
- Deployment: https://www.uvicorn.org/deployment/

**SQLite Read-Only:**
- URI parameters: https://www.sqlite.org/uri.html

**CORS:**
- MDN docs: https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS

---

## ‚è≠Ô∏è Next Steps After Story 5.1

Once this story is complete:

1. **Story 5.2:** Event API Endpoints
   - Build on FastAPI application
   - Add `/api/events` endpoints
   - Implement pagination and filtering

2. **Story 5.3:** Real-Time Event Streaming
   - Add WebSocket support
   - Integrate with EventManager
   - Real-time event broadcasting

3. **Story 5.4:** Dashboard HTML/CSS Framework
   - Replace placeholder index.html
   - Build responsive dashboard layout
   - Implement dark mode design

---

## üìù Definition of Done

Before marking this story complete, verify:

- [ ] All 12 acceptance criteria met
- [ ] All unit tests passing (>80% coverage)
- [ ] Integration tests passing
- [ ] Manual testing checklist complete
- [ ] README.md updated
- [ ] Code reviewed
- [ ] No linting errors: `ruff check api/`
- [ ] Type hints added: `mypy api/`
- [ ] Git commit with message: "feat: Complete Story 5.1 - FastAPI Server Setup"

---

**Estimated Time Breakdown:**
- Setup & dependencies: 30 min
- Core implementation: 3 hours
- Testing: 1.5 hours
- Documentation: 1 hour
- Code review & fixes: 1 hour
- **Total: 7 hours**

Good luck! üöÄ

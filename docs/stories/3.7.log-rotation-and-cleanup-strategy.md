# Story 3.7: Log Rotation and Cleanup Strategy

## Status
Approved

## Story
**As a** developer,
**I want** to implement FIFO log rotation to manage disk space,
**so that** old logs are deleted when storage limit is approached.

## Acceptance Criteria
1. Log rotation module (core/log_rotation.py) implements LogRotator class with rotate_logs() method
2. Rotation strategy: Delete oldest date directories when storage >90% of limit
3. rotate_logs() identifies oldest directories by date (YYYY-MM-DD) in data/events/
4. Deletion order: Oldest first, continues until storage <80% of limit
5. Deletion includes: Date directory with all contents (JSON logs, plaintext logs, annotated images)
6. Rotation logged at WARNING level: "Storage limit approaching, deleting old logs: 2025-10-15 (freed [X]MB)"
7. Protection: Never delete events from current day (today's directory is protected)
8. Minimum retention: Keep at least 7 days of data regardless of storage (configurable via min_retention_days)
9. rotate_logs() called automatically when storage check detects >90% usage
10. Manual rotation support: rotate_logs(force=True) bypasses percentage check
11. Unit tests verify: oldest directory identification, deletion logic, protection rules
12. Integration test: Fill storage to 95%, trigger rotation, verify oldest logs deleted and storage reduced

## Tasks / Subtasks
- [ ] Task 1: Create LogRotator class in core/log_rotation.py (AC: 1)
  - [ ] Implement __init__ method with SystemConfig and StorageMonitor dependency injection
  - [ ] Add rotate_logs(force=False) method signature
  - [ ] Import required modules: os, shutil, pathlib, datetime
- [ ] Task 2: Implement directory identification logic (AC: 2, 3)
  - [ ] Scan data/events/ directory for YYYY-MM-DD formatted subdirectories
  - [ ] Sort directories by date (oldest first)
  - [ ] Filter out current day's directory for protection
  - [ ] Apply minimum retention policy (7 days default)
- [ ] Task 3: Implement rotation trigger conditions (AC: 2, 9)
  - [ ] Check if storage usage >90% of limit (unless force=True)
  - [ ] Integrate with StorageMonitor.check_usage() method
  - [ ] Return early if rotation not needed
  - [ ] Log rotation initiation at WARNING level
- [ ] Task 4: Implement FIFO deletion strategy (AC: 4, 5)
  - [ ] Delete directories in oldest-first order
  - [ ] Continue until storage <80% of limit
  - [ ] Use shutil.rmtree() for complete directory removal
  - [ ] Calculate and return total bytes freed
- [ ] Task 5: Implement safety protections (AC: 7, 8)
  - [ ] Never delete current day's directory (based on system date)
  - [ ] Enforce minimum retention period (configurable min_retention_days)
  - [ ] Validate directory names are valid YYYY-MM-DD format
  - [ ] Handle deletion errors gracefully (log but continue)
- [ ] Task 6: Implement logging and monitoring (AC: 6)
  - [ ] Log each deletion at WARNING level with directory name and bytes freed
  - [ ] Format bytes freed in human-readable units (MB, GB)
  - [ ] Log rotation completion with total bytes freed
  - [ ] Include error logging for failed deletions
- [ ] Task 7: Implement manual rotation support (AC: 10)
  - [ ] Add force parameter to bypass percentage-based triggering
  - [ ] Allow manual cleanup regardless of current storage usage
  - [ ] Log manual rotation initiation differently from automatic
- [ ] Task 8: Create comprehensive unit tests (AC: 11)
  - [ ] Test directory identification and sorting logic
  - [ ] Test deletion order (oldest first)
  - [ ] Test protection rules (current day, minimum retention)
  - [ ] Test trigger conditions (90% threshold, force mode)
  - [ ] Mock file system operations for safe testing
- [ ] Task 9: Create integration test (AC: 12)
  - [ ] Create test directory structure with multiple date directories
  - [ ] Fill storage to 95% by adding test files
  - [ ] Trigger automatic rotation and verify oldest directories deleted
  - [ ] Verify storage reduced below 80% threshold
  - [ ] Clean up test directories after completion

## Dev Notes

### Previous Story Insights
From Story 3.6 Storage Monitoring: StorageStats object and threshold logic established. File system operations patterns for directory scanning and size calculations. Integration patterns with StorageMonitor class.

### Data Models
- **SystemConfig**: Contains min_retention_days parameter for minimum data retention [Source: architecture/systemconfig.md]
- **StorageMonitor**: Provides check_usage() method for current storage status [Source: architecture/storage-monitor.md]
- **Directory Structure**: data/events/YYYY-MM-DD/ format for date-based organization [Source: architecture/log-rotator.md]

### File Locations
- **Module Location**: core/log_rotation.py [Source: architecture/log-rotator.md]
- **Class Name**: LogRotator [Source: architecture/log-rotator.md]
- **Target Directory**: data/events/ (contains date subdirectories to rotate) [Source: architecture/log-rotator.md]
- **Dependencies**: SystemConfig and StorageMonitor for configuration and status [Source: architecture/log-rotator.md]

### Technical Constraints
- **Rotation Trigger**: Storage >90% of limit (unless force=True) [Source: epic-3-event-persistence-data-management.md AC: 2, 9]
- **Deletion Target**: Storage <80% of limit after rotation [Source: epic-3-event-persistence-data-management.md AC: 4]
- **Protection Rules**: Never delete current day, minimum 7 days retention [Source: epic-3-event-persistence-data-management.md AC: 7, 8]
- **Deletion Scope**: Complete date directories (JSON logs, plaintext logs, images) [Source: epic-3-event-persistence-data-management.md AC: 5]
- **Sorting Logic**: Oldest directories first (by YYYY-MM-DD date) [Source: epic-3-event-persistence-data-management.md AC: 3]

### Testing Requirements
- **Test Location**: tests/unit/test_log_rotation.py [Source: architecture/test-organization.md]
- **Test Framework**: pytest with standard assertions [Source: architecture/test-organization.md]
- **Coverage Target**: ≥70% including error scenarios [Source: architecture/test-organization.md]
- **Mock Strategy**: Mock file system operations and directory structures [Source: architecture/test-organization.md]
- **Integration Test**: tests/integration/test_log_rotation_integration.py [Source: architecture/test-organization.md]

### Project Structure Notes
- Follows core/ module organization for platform-independent components [Source: architecture/repository-structure.md]
- Log rotator is a system maintenance component alongside storage monitor [Source: architecture/repository-structure.md]
- No structural conflicts identified between epic requirements and architecture patterns

## Testing

### Testing Standards
- **Test File Location**: tests/unit/test_log_rotation.py for unit tests, tests/integration/test_log_rotation_integration.py for integration tests [Source: architecture/test-organization.md]
- **Test Framework**: pytest 7.4+ with pytest-cov for coverage reporting [Source: architecture/test-organization.md]
- **Coverage Requirements**: Target ≥70% coverage across core/log_rotation.py [Source: architecture/test-organization.md]
- **Mocking Strategy**: Use pytest-mock for file system operations, create mock directory structures for testing [Source: architecture/test-organization.md]
- **Test Patterns**: Arrange-Act-Assert pattern, test both success and error scenarios [Source: architecture/unit-test-best-practices.md]
- **Performance Testing**: Include timing assertions for directory scanning and deletion operations [Source: architecture/performance-test-examples.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-10 | 1.0 | Initial story draft created from Epic 3 requirements | SM Agent (Bob) |
| 2025-11-10 | 1.1 | Status changed from Draft to Approved after checklist validation | SM Agent (Bob) |

## Dev Agent Record

### Agent Model Used
*To be populated by development agent*

### Debug Log References
*To be populated by development agent*

### Completion Notes List
*To be populated by development agent*

### File List
*To be populated by development agent*

## QA Results
*To be populated by QA agent*
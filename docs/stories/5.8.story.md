# Story 5.8: Search and Filtering

**Epic:** Epic 5 - Web Dashboard & Real-Time Monitoring
**Story ID:** 5.8
**Title:** Search and Filtering
**Estimated Effort:** 10-12 hours (1.5 days)
**Priority:** Medium
**Dependencies:** Stories 5.1, 5.2, 5.4, 5.5

---

## Story Description

**As a** system operator
**I want** to filter motion detection events by camera, time range, and detected objects
**So that** I can quickly find specific events and analyze patterns

### Context

Story 5.8 builds on the event feed from Story 5.5:
- **Story 5.5:** Event feed displays all events
- **Story 5.4:** Dashboard has sidebar for filters
- **Story 5.2:** `/api/events` endpoint supports query parameters

This story implements search and filtering functionality:
1. Filter by camera ID (single or multiple cameras)
2. Filter by date range (start date, end date)
3. Filter by time range (start time, end time)
4. Search by detected object name (text search)
5. Apply filters to event feed (client-side and server-side)
6. Clear all filters button
7. Persist filters in URL and localStorage

---

## Business Value

**User Impact:**
- Operators can quickly find events from specific cameras
- Time-based filtering for incident investigation
- Object-based search for tracking specific detections (people, vehicles)
- Shareable filtered views via URL

**Technical Value:**
- Validates `/api/events` query parameters from Story 5.2
- Demonstrates client-side state management
- Provides foundation for analytics features (future enhancement)

**Success Metrics:**
- Filters applied within 500ms
- Filtered events load within 1 second
- URL updates reflect current filters (shareable)
- Filters persist across page refreshes

---

## Acceptance Criteria

### AC1: Camera Filter Displayed
**Given** the dashboard is loaded
**When** the sidebar/filter panel is visible
**Then** the system should display:
- Camera filter section with checkboxes
- List of all configured cameras (e.g., "Camera 1", "Camera 2")
- "Select All" and "Clear All" options
- Active filter count (e.g., "2 cameras selected")

**Verification:**
```bash
# Open dashboard
# Verify sidebar shows camera filter
# Verify all cameras listed
# Check "Camera 1" checkbox
# Verify "1 camera selected" label updates
```

---

### AC2: Date Range Filter Displayed
**Given** the dashboard is loaded
**When** the sidebar/filter panel is visible
**Then** the system should display:
- Start date input (date picker)
- End date input (date picker)
- "Today", "Last 7 days", "Last 30 days" quick filters
- "Clear date range" button

**Verification:**
```bash
# Open dashboard
# Verify date range inputs displayed
# Click "Today" quick filter
# Verify start date = today, end date = today
# Click "Last 7 days"
# Verify start date = 7 days ago, end date = today
```

---

### AC3: Object Search Displayed
**Given** the dashboard is loaded
**When** the sidebar/filter panel is visible
**Then** the system should display:
- Text input for object search
- Placeholder: "Search by object (person, car, dog...)"
- Search icon
- Clear button (when text entered)

**Verification:**
```bash
# Open dashboard
# Verify object search input displayed
# Type "person" in search box
# Verify clear button (‚úï) appears
```

---

### AC4: Apply Camera Filter
**Given** camera filter checkboxes are displayed
**When** the user checks "Camera 1" and "Camera 2"
**Then** the system should:
- Filter event feed to show only events from Camera 1 and Camera 2
- Update URL: `?camera=Camera+1&camera=Camera+2`
- Display filter count: "2 filters active"
- Update event feed within 500ms

**Verification:**
```bash
# Open dashboard (with events from multiple cameras)
# Check "Camera 1" checkbox
# Verify: Only Camera 1 events displayed
# Check URL: contains ?camera=Camera+1
# Check "Camera 2" checkbox
# Verify: Camera 1 and Camera 2 events displayed
# Check URL: contains both camera parameters
```

---

### AC5: Apply Date Range Filter
**Given** date range inputs are displayed
**When** the user selects start date "2025-11-01" and end date "2025-11-10"
**Then** the system should:
- Filter event feed to show only events between those dates
- Update URL: `?start=2025-11-01&end=2025-11-10`
- Display filter count: "Date range active"
- Update event feed within 500ms

**Verification:**
```bash
# Open dashboard
# Set start date: 2025-11-01
# Set end date: 2025-11-10
# Verify: Only events in that range displayed
# Check URL: contains date parameters
```

---

### AC6: Apply Object Search Filter
**Given** object search input is displayed
**When** the user types "person" and presses Enter
**Then** the system should:
- Filter event feed to show only events with "person" in detected_objects
- Update URL: `?object=person`
- Display filter count: "Searching for: person"
- Update event feed within 500ms
- Highlight "person" in detected objects list

**Verification:**
```bash
# Open dashboard
# Type "person" in object search
# Press Enter
# Verify: Only events with "person" detected displayed
# Verify: "person" highlighted in event cards
```

---

### AC7: Combine Multiple Filters
**Given** multiple filters are available
**When** the user applies camera filter AND date range AND object search
**Then** the system should:
- Apply all filters simultaneously (AND logic)
- Update URL with all filter parameters
- Display filter count: "3 filters active"
- Show "Clear all filters" button

**Verification:**
```bash
# Apply filters:
# - Camera: Camera 1
# - Date range: 2025-11-01 to 2025-11-10
# - Object: person

# Verify: Only events matching ALL criteria displayed
# Check URL: contains all filter parameters
# Verify: "3 filters active" badge displayed
```

---

### AC8: Clear All Filters
**Given** filters are active
**When** the user clicks "Clear all filters" button
**Then** the system should:
- Remove all filters
- Display all events (unfiltered)
- Update URL to remove filter parameters
- Hide filter count badge
- Reset all filter inputs

**Verification:**
```bash
# Apply multiple filters
# Click "Clear all filters" button
# Verify: All events displayed
# Verify: URL has no filter parameters
# Verify: All checkboxes unchecked
# Verify: Date inputs cleared
# Verify: Object search cleared
```

---

### AC9: URL-Based Filters (Shareable Links)
**Given** filters are active
**When** the user copies the URL and opens it in a new tab
**Then** the system should:
- Parse URL parameters on page load
- Apply filters from URL
- Display filtered events
- Show filter count and active filters

**Verification:**
```bash
# Apply filters (e.g., Camera 1, date range, object: person)
# Copy URL: http://localhost:8000/?camera=Camera+1&start=2025-11-01&end=2025-11-10&object=person
# Open URL in new tab
# Verify: Filters applied automatically
# Verify: Filtered events displayed
```

---

### AC10: Persist Filters in localStorage
**Given** filters are active
**When** the user refreshes the page
**Then** the system should:
- Load filters from localStorage
- Apply saved filters
- Display filtered events
- Show filter count

**Verification:**
```bash
# Apply filters
# Refresh page (F5)
# Verify: Filters still active
# Verify: Filtered events displayed

# Check localStorage:
# Open DevTools > Application > Local Storage
# Verify: Filter state saved
```

---

### AC11: Filter Count Badge
**Given** filters are active
**When** filters are applied
**Then** the system should display:
- Badge showing number of active filters
- Badge location: Sidebar header or filter button
- Badge text: "3 filters active"
- Badge color: Accent color (blue)

**Verification:**
```bash
# Apply 1 filter
# Verify: Badge shows "1 filter active"

# Apply 3 filters
# Verify: Badge shows "3 filters active"

# Clear all filters
# Verify: Badge hidden
```

---

### AC12: No Results State
**Given** filters are active
**When** no events match the filter criteria
**Then** the system should display:
- Empty state message: "No events match your filters"
- "Clear filters" button
- List of active filters

**Verification:**
```bash
# Apply very restrictive filters (no matching events)
# Example: Camera 1 + date: 2020-01-01 to 2020-01-02
# Verify: "No events match your filters" message
# Verify: "Clear filters" button displayed
# Click "Clear filters"
# Verify: All events displayed
```

---

## Technical Design

### Architecture Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ      Search and Filtering Component         ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   FilterPanel Component             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Camera checkboxes                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Date range inputs                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Object search input              ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Clear filters button             ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ             ‚îÇ filterChange event           ‚îÇ
‚îÇ             ‚ñº                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   FilterState (State Management)    ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - cameras: string[]                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - startDate: string                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - endDate: string                  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - object: string                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - applyFilters()                   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - clearFilters()                   ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ             ‚îÇ notify(subscribers)          ‚îÇ
‚îÇ             ‚ñº                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   EventFeed Component               ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Fetch filtered events from API   ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Display filtered events          ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ             ‚îÇ                               ‚îÇ
‚îÇ             ‚ñº                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   ApiClient Service                 ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - GET /api/events?filters...       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ             ‚îÇ                               ‚îÇ
‚îÇ             ‚ñº                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ   URL & localStorage                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Sync filters with URL params     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  - Persist filters in localStorage  ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### File Structure

```
web/
‚îú‚îÄ‚îÄ js/
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FilterPanel.js       # Filter UI component
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EventFeed.js         # Updated to handle filters
‚îÇ   ‚îú‚îÄ‚îÄ state/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FilterState.js       # Filter state management
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ urlParams.js         # URL parameter parsing
‚îÇ       ‚îî‚îÄ‚îÄ localStorage.js      # LocalStorage helpers
‚îî‚îÄ‚îÄ css/
    ‚îî‚îÄ‚îÄ components.css           # Updated with filter styles
```

---

## Implementation Details

### 1. FilterState (State Management)

```javascript
// web/js/state/FilterState.js

class FilterState {
  constructor() {
    this.filters = {
      cameras: [],         // Array of camera IDs
      startDate: null,     // ISO date string or null
      endDate: null,       // ISO date string or null
      object: null         // Object name or null
    };

    this.subscribers = [];

    // Load filters from URL or localStorage
    this.loadSavedFilters();

    console.log('[FilterState] Initialized with filters:', this.filters);
  }

  // Observer Pattern: Subscribe to filter changes
  subscribe(callback) {
    this.subscribers.push(callback);

    return () => {
      this.subscribers = this.subscribers.filter(sub => sub !== callback);
    };
  }

  // Notify all subscribers of filter change
  notify() {
    console.log('[FilterState] Notifying subscribers of filter change');

    this.subscribers.forEach(callback => {
      try {
        callback(this.filters);
      } catch (error) {
        console.error('[FilterState] Subscriber callback failed:', error);
      }
    });

    // Sync with URL and localStorage
    this.syncFilters();
  }

  // Set camera filter
  setCameras(cameras) {
    console.log('[FilterState] Set cameras:', cameras);
    this.filters.cameras = cameras;
    this.notify();
  }

  // Set date range filter
  setDateRange(startDate, endDate) {
    console.log('[FilterState] Set date range:', startDate, 'to', endDate);
    this.filters.startDate = startDate;
    this.filters.endDate = endDate;
    this.notify();
  }

  // Set object search filter
  setObject(object) {
    console.log('[FilterState] Set object:', object);
    this.filters.object = object;
    this.notify();
  }

  // Clear all filters
  clearFilters() {
    console.log('[FilterState] Clearing all filters');
    this.filters = {
      cameras: [],
      startDate: null,
      endDate: null,
      object: null
    };
    this.notify();
  }

  // Get current filters
  getFilters() {
    return { ...this.filters };
  }

  // Check if any filters are active
  hasActiveFilters() {
    return (
      this.filters.cameras.length > 0 ||
      this.filters.startDate !== null ||
      this.filters.endDate !== null ||
      this.filters.object !== null
    );
  }

  // Count active filters
  getActiveFilterCount() {
    let count = 0;
    if (this.filters.cameras.length > 0) count++;
    if (this.filters.startDate || this.filters.endDate) count++;
    if (this.filters.object) count++;
    return count;
  }

  // Sync filters with URL and localStorage
  syncFilters() {
    // Update URL
    const params = new URLSearchParams();

    this.filters.cameras.forEach(camera => {
      params.append('camera', camera);
    });

    if (this.filters.startDate) {
      params.set('start', this.filters.startDate);
    }

    if (this.filters.endDate) {
      params.set('end', this.filters.endDate);
    }

    if (this.filters.object) {
      params.set('object', this.filters.object);
    }

    // Update URL without page reload
    const newUrl = params.toString() ? `?${params.toString()}` : window.location.pathname;
    window.history.replaceState({}, '', newUrl);

    // Save to localStorage
    localStorage.setItem('eventFilters', JSON.stringify(this.filters));

    console.log('[FilterState] Synced filters to URL and localStorage');
  }

  // Load filters from URL or localStorage
  loadSavedFilters() {
    // Priority 1: URL parameters (for shareable links)
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.has('camera') || urlParams.has('start') || urlParams.has('end') || urlParams.has('object')) {
      console.log('[FilterState] Loading filters from URL');

      this.filters.cameras = urlParams.getAll('camera');
      this.filters.startDate = urlParams.get('start');
      this.filters.endDate = urlParams.get('end');
      this.filters.object = urlParams.get('object');

      return;
    }

    // Priority 2: localStorage (for persisting user preferences)
    const savedFilters = localStorage.getItem('eventFilters');

    if (savedFilters) {
      console.log('[FilterState] Loading filters from localStorage');

      try {
        this.filters = JSON.parse(savedFilters);
      } catch (error) {
        console.error('[FilterState] Failed to parse saved filters:', error);
      }
    }
  }
}

// Singleton instance
const filterState = new FilterState();

export default filterState;
```

---

### 2. FilterPanel Component

```javascript
// web/js/components/FilterPanel.js

import filterState from '../state/FilterState.js';

class FilterPanel {
  constructor(containerSelector) {
    this.container = document.querySelector(containerSelector);
    if (!this.container) {
      throw new Error(`Container not found: ${containerSelector}`);
    }

    this.cameras = ['Camera 1', 'Camera 2', 'Camera 3']; // TODO: Fetch from API

    this.render();
    this.attachEventListeners();

    // Subscribe to filter state changes
    filterState.subscribe(() => {
      this.updateFilterCountBadge();
    });

    console.log('[FilterPanel] Initialized');
  }

  render() {
    const filters = filterState.getFilters();

    this.container.innerHTML = `
      <div class="filter-panel">
        <div class="filter-header">
          <h3>Filters</h3>
          <span class="filter-count-badge" style="display: none;"></span>
        </div>

        <!-- Camera Filter -->
        <div class="filter-section">
          <h4>Camera</h4>
          <div class="camera-filters">
            ${this.cameras.map(camera => `
              <label class="filter-checkbox">
                <input
                  type="checkbox"
                  name="camera"
                  value="${camera}"
                  ${filters.cameras.includes(camera) ? 'checked' : ''}
                />
                <span>${camera}</span>
              </label>
            `).join('')}
          </div>
        </div>

        <!-- Date Range Filter -->
        <div class="filter-section">
          <h4>Date Range</h4>
          <div class="date-range-filter">
            <input
              type="date"
              id="start-date"
              class="date-input"
              value="${filters.startDate || ''}"
              placeholder="Start date"
            />
            <input
              type="date"
              id="end-date"
              class="date-input"
              value="${filters.endDate || ''}"
              placeholder="End date"
            />
          </div>
          <div class="date-quick-filters">
            <button class="btn-quick-filter" data-range="today">Today</button>
            <button class="btn-quick-filter" data-range="week">Last 7 days</button>
            <button class="btn-quick-filter" data-range="month">Last 30 days</button>
          </div>
        </div>

        <!-- Object Search Filter -->
        <div class="filter-section">
          <h4>Detected Objects</h4>
          <div class="object-search">
            <input
              type="text"
              id="object-search"
              class="search-input"
              value="${filters.object || ''}"
              placeholder="Search by object (person, car...)"
            />
            <button class="btn-search" aria-label="Search">üîç</button>
          </div>
        </div>

        <!-- Clear Filters Button -->
        <button class="btn-clear-filters">Clear All Filters</button>
      </div>
    `;

    this.updateFilterCountBadge();
  }

  attachEventListeners() {
    // Camera checkboxes
    const cameraCheckboxes = this.container.querySelectorAll('input[name="camera"]');
    cameraCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const selectedCameras = Array.from(cameraCheckboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);

        filterState.setCameras(selectedCameras);
      });
    });

    // Date range inputs
    const startDateInput = this.container.querySelector('#start-date');
    const endDateInput = this.container.querySelector('#end-date');

    startDateInput.addEventListener('change', () => {
      filterState.setDateRange(startDateInput.value, endDateInput.value);
    });

    endDateInput.addEventListener('change', () => {
      filterState.setDateRange(startDateInput.value, endDateInput.value);
    });

    // Date quick filters
    const quickFilterButtons = this.container.querySelectorAll('.btn-quick-filter');
    quickFilterButtons.forEach(button => {
      button.addEventListener('click', () => {
        const range = button.getAttribute('data-range');
        this.applyQuickDateFilter(range);
      });
    });

    // Object search
    const objectSearchInput = this.container.querySelector('#object-search');
    const searchButton = this.container.querySelector('.btn-search');

    const performSearch = () => {
      filterState.setObject(objectSearchInput.value.trim() || null);
    };

    searchButton.addEventListener('click', performSearch);

    objectSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // Clear filters button
    const clearButton = this.container.querySelector('.btn-clear-filters');
    clearButton.addEventListener('click', () => {
      filterState.clearFilters();
      this.render(); // Re-render to reset all inputs
    });
  }

  applyQuickDateFilter(range) {
    const today = new Date();
    const startDate = new Date();

    if (range === 'today') {
      // Start and end = today
    } else if (range === 'week') {
      startDate.setDate(today.getDate() - 7);
    } else if (range === 'month') {
      startDate.setDate(today.getDate() - 30);
    }

    const startDateStr = startDate.toISOString().split('T')[0];
    const endDateStr = today.toISOString().split('T')[0];

    filterState.setDateRange(startDateStr, endDateStr);

    // Update inputs
    this.container.querySelector('#start-date').value = startDateStr;
    this.container.querySelector('#end-date').value = endDateStr;
  }

  updateFilterCountBadge() {
    const badge = this.container.querySelector('.filter-count-badge');
    const count = filterState.getActiveFilterCount();

    if (count > 0) {
      badge.textContent = `${count} filter${count > 1 ? 's' : ''} active`;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }
}

export default FilterPanel;
```

---

### 3. Update EventFeed to Handle Filters

```javascript
// web/js/components/EventFeed.js (additions)

import filterState from '../state/FilterState.js';

class EventFeed {
  constructor(containerSelector) {
    // ... existing code ...

    // Subscribe to filter changes
    filterState.subscribe((filters) => {
      this.applyFilters(filters);
    });
  }

  async applyFilters(filters) {
    console.log('[EventFeed] Applying filters:', filters);

    this.showLoading();
    this.offset = 0; // Reset offset
    this.renderedEventIds.clear(); // Clear rendered events

    try {
      // Build query parameters
      const params = {
        limit: 100,
        offset: 0
      };

      if (filters.cameras.length > 0) {
        // Note: API may need to support multiple camera IDs
        // For now, fetch events and filter client-side
        params.camera_id = filters.cameras[0]; // TODO: Support multiple cameras
      }

      if (filters.startDate) {
        params.start = filters.startDate;
      }

      if (filters.endDate) {
        params.end = filters.endDate;
      }

      // Fetch filtered events from API
      const response = await this.apiClient.getEvents(params);

      // Client-side filtering for object search
      let filteredEvents = response.events;

      if (filters.object) {
        filteredEvents = filteredEvents.filter(event => {
          if (!event.detected_objects) return false;

          try {
            const objects = JSON.parse(event.detected_objects);
            return objects.some(obj =>
              obj.name.toLowerCase().includes(filters.object.toLowerCase())
            );
          } catch (error) {
            return false;
          }
        });
      }

      // Clear event store and add filtered events
      eventStore.clear();
      eventStore.addEvents(filteredEvents);

      this.hasMore = response.total > filteredEvents.length;
      this.offset = filteredEvents.length;

      console.log(`[EventFeed] Loaded ${filteredEvents.length} filtered events`);
    } catch (error) {
      console.error('[EventFeed] Failed to apply filters:', error);
      this.showError('Failed to load filtered events');
    } finally {
      this.hideLoading();
    }
  }
}
```

---

### 4. CSS Additions

```css
/* web/css/components.css - Filter Panel Additions */

.filter-panel {
  padding: var(--spacing-lg);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-lg);
}

.filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: var(--spacing-sm);
  border-bottom: 1px solid var(--bg-tertiary);
}

.filter-header h3 {
  margin: 0;
  font-size: var(--font-size-lg);
  color: var(--text-primary);
}

.filter-count-badge {
  background: var(--accent-primary);
  color: white;
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-sm);
  font-weight: 600;
}

.filter-section {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.filter-section h4 {
  margin: 0;
  font-size: var(--font-size-base);
  color: var(--text-secondary);
  font-weight: 600;
}

/* Camera Filters */
.camera-filters {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.filter-checkbox {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs);
  cursor: pointer;
  transition: background var(--transition-fast);
  border-radius: var(--radius-sm);
}

.filter-checkbox:hover {
  background: var(--bg-tertiary);
}

.filter-checkbox input[type="checkbox"] {
  cursor: pointer;
}

/* Date Range Filter */
.date-range-filter {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
}

.date-input {
  padding: var(--spacing-sm);
  background: var(--bg-tertiary);
  border: 1px solid var(--bg-primary);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: var(--font-size-sm);
}

.date-input:focus {
  outline: 2px solid var(--accent-primary);
  outline-offset: 1px;
}

.date-quick-filters {
  display: flex;
  gap: var(--spacing-xs);
}

.btn-quick-filter {
  flex: 1;
  padding: var(--spacing-xs);
  background: var(--bg-tertiary);
  border: none;
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: var(--font-size-sm);
  cursor: pointer;
  transition: background var(--transition-fast);
}

.btn-quick-filter:hover {
  background: var(--accent-primary);
  color: white;
}

/* Object Search */
.object-search {
  display: flex;
  gap: var(--spacing-xs);
}

.search-input {
  flex: 1;
  padding: var(--spacing-sm);
  background: var(--bg-tertiary);
  border: 1px solid var(--bg-primary);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-size: var(--font-size-sm);
}

.search-input:focus {
  outline: 2px solid var(--accent-primary);
  outline-offset: 1px;
}

.btn-search {
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--accent-primary);
  border: none;
  border-radius: var(--radius-sm);
  font-size: var(--font-size-lg);
  cursor: pointer;
  transition: background var(--transition-fast);
}

.btn-search:hover {
  background: var(--accent-primary-dark);
}

/* Clear Filters Button */
.btn-clear-filters {
  padding: var(--spacing-sm) var(--spacing-md);
  background: transparent;
  border: 1px solid var(--accent-error);
  border-radius: var(--radius-sm);
  color: var(--accent-error);
  font-size: var(--font-size-sm);
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.btn-clear-filters:hover {
  background: var(--accent-error);
  color: white;
}

/* No Results State (in EventFeed) */
.no-results {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: var(--spacing-xxl);
  text-align: center;
}

.no-results h3 {
  color: var(--text-primary);
  margin-bottom: var(--spacing-sm);
}

.no-results p {
  color: var(--text-secondary);
  margin-bottom: var(--spacing-md);
}
```

---

## Testing Strategy

### Manual Tests

```bash
# Test 1: Camera Filter
# Check "Camera 1" checkbox
# Verify: Only Camera 1 events displayed
# Verify: URL contains ?camera=Camera+1
# Verify: Filter count badge: "1 filter active"

# Test 2: Date Range Filter
# Click "Last 7 days" button
# Verify: Events from last 7 days displayed
# Verify: URL contains start/end parameters

# Test 3: Object Search
# Type "person" and press Enter
# Verify: Only events with "person" detected displayed
# Verify: URL contains ?object=person

# Test 4: Combined Filters
# Apply camera + date range + object filters
# Verify: Events match ALL criteria
# Verify: Filter count badge: "3 filters active"

# Test 5: Clear Filters
# Click "Clear All Filters" button
# Verify: All events displayed
# Verify: All filter inputs cleared
# Verify: URL has no filter parameters

# Test 6: Shareable URL
# Apply filters
# Copy URL
# Open in new tab
# Verify: Filters applied automatically

# Test 7: Persist Filters
# Apply filters
# Refresh page (F5)
# Verify: Filters still active

# Test 8: No Results
# Apply restrictive filters (no matching events)
# Verify: "No events match your filters" message
```

---

## Non-Functional Requirements

| ID | Requirement | Implementation |
|----|-------------|----------------|
| **NFR43** | Filters applied in <500ms | Efficient client-side filtering |
| **NFR44** | Filtered events load in <1s | Optimized API queries |
| **NFR45** | URL updates reflect filters | URL parameters sync |
| **NFR46** | Filters persist across refreshes | localStorage + URL params |

---

## Dependencies

**Blocked By:**
- Story 5.2: Event API Endpoints (query parameters)
- Story 5.4: Dashboard HTML/CSS (sidebar structure)
- Story 5.5: Event Feed Component (event display)

**Blocks:**
- None (final story in Epic 5)

---

## Definition of Done

- [ ] All 12 acceptance criteria verified
- [ ] Camera filter working
- [ ] Date range filter working
- [ ] Object search filter working
- [ ] Combined filters working (AND logic)
- [ ] Clear filters button working
- [ ] URL parameters sync with filters
- [ ] localStorage persists filters
- [ ] Filter count badge displayed
- [ ] No results state displayed
- [ ] Manual testing completed (8 test cases)

---

## Related Documentation

- **Story 5.2:** Event API Endpoints (query parameters)
- **Story 5.4:** Dashboard HTML/CSS Framework
- **Story 5.5:** Event Feed Component

---

## Revision History

| Date | Version | Changes | Author |
|------|---------|---------|--------|
| 2025-11-10 | 1.0 | Initial story creation | Winston (Architect) |
